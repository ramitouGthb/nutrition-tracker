<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=1024">
<title>××—×©×‘×•×Ÿ ×ª×–×•× ×”</title>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;900&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0f1117;--surface:#1a1d27;--surface2:#21253a;--surface3:#2a2f47;
  --accent:#4f9cf9;--accent2:#7c5cbf;--green:#3ecf8e;--orange:#f5a623;
  --red:#e85d4a;--yellow:#f5d020;--text:#e8eaf0;--text2:#8b92a9;
  --border:#2e3454;--radius:12px;
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;overflow:hidden;}
body{font-family:'Heebo',sans-serif;background:var(--bg);color:var(--text);direction:rtl;display:flex;flex-direction:column;}

/* â”€â”€ HEADER â”€â”€ */
.header{background:linear-gradient(135deg,var(--surface),#161929);border-bottom:1px solid var(--border);padding:14px 28px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;z-index:100;}
.header-title{font-family:'Rajdhani',sans-serif;font-size:22px;font-weight:700;letter-spacing:2px;color:var(--accent);}
.header-right{display:flex;align-items:center;gap:16px;}
.header-date{color:var(--text2);font-size:14px;}
.settings-btn{padding:8px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text2);cursor:pointer;font-family:'Heebo',sans-serif;font-size:13px;display:flex;align-items:center;gap:6px;transition:all .2s;}
.settings-btn:hover{border-color:var(--accent);color:var(--accent);}

/* â”€â”€ TABS â”€â”€ */
.tabs{display:flex;background:var(--surface);border-bottom:1px solid var(--border);padding:0 28px;flex-shrink:0;}
.tab{padding:12px 22px;cursor:pointer;font-size:14px;font-weight:500;color:var(--text2);border-bottom:2px solid transparent;transition:all .2s;}
.tab.active{color:var(--accent);border-bottom-color:var(--accent);}
.tab:hover{color:var(--text);}

/* â”€â”€ STICKY TOP (day setup + macros) â”€â”€ */
.sticky-top{flex-shrink:0;padding:20px 28px 0;background:var(--bg);}

/* â”€â”€ SCROLL AREA â”€â”€ */
.scroll-area{flex:1;overflow-y:auto;padding:0 28px 28px;}
.scroll-area::-webkit-scrollbar{width:6px;}
.scroll-area::-webkit-scrollbar-track{background:var(--bg);}
.scroll-area::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}

/* â”€â”€ CARDS â”€â”€ */
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px 22px;margin-bottom:16px;}
.card-title{font-size:11px;font-weight:700;letter-spacing:1.5px;color:var(--text2);text-transform:uppercase;margin-bottom:14px;}

/* â”€â”€ DAY SETUP â”€â”€ */
.day-setup{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
.day-type-btn{padding:9px 16px;border-radius:8px;border:1px solid var(--border);background:var(--surface2);color:var(--text2);cursor:pointer;font-family:'Heebo',sans-serif;font-size:13px;font-weight:500;transition:all .2s;}
.day-type-btn.active-rest{background:rgba(62,207,142,.15);border-color:var(--green);color:var(--green);}
.day-type-btn.active-train{background:rgba(79,156,249,.15);border-color:var(--accent);color:var(--accent);}
.date-input{padding:9px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'Heebo',sans-serif;font-size:14px;outline:none;}
.date-input:focus{border-color:var(--accent);}

/* â”€â”€ MACROS BAR â”€â”€ */
.macros-bar{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px;}
.macro-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;position:relative;overflow:hidden;}
.macro-card::before{content:'';position:absolute;top:0;right:0;width:3px;height:100%;}
.macro-card.cal::before{background:var(--orange);}
.macro-card.protein::before{background:var(--accent);}
.macro-card.carbs::before{background:var(--green);}
.macro-card.fat::before{background:var(--accent2);}
.macro-top{display:flex;justify-content:space-between;align-items:flex-start;}
.macro-label{font-size:11px;color:var(--text2);letter-spacing:1px;text-transform:uppercase;margin-bottom:4px;}
.macro-value{font-family:'Rajdhani',sans-serif;font-size:26px;font-weight:700;line-height:1;}
.macro-card.cal .macro-value{color:var(--orange);}
.macro-card.protein .macro-value{color:var(--accent);}
.macro-card.carbs .macro-value{color:var(--green);}
.macro-card.fat .macro-value{color:var(--accent2);}
.macro-unit{font-size:11px;color:var(--text2);margin-top:1px;}
.macro-target{font-size:14px;color:var(--text2);font-weight:600;display:inline;}
.macro-target-row{margin-top:5px;display:flex;align-items:center;gap:6px;}
.macro-progress{margin-top:6px;height:3px;background:var(--surface3);border-radius:2px;overflow:hidden;}
.macro-progress-fill{height:100%;border-radius:2px;transition:width .4s ease;}
.macro-card.cal .macro-progress-fill{background:var(--orange);}
.macro-card.protein .macro-progress-fill{background:var(--accent);}
.macro-card.carbs .macro-progress-fill{background:var(--green);}
.macro-card.fat .macro-progress-fill{background:var(--accent2);}

/* Status badge */
.macro-status{font-size:11px;font-weight:700;padding:2px 7px;border-radius:20px;white-space:nowrap;margin-top:4px;display:inline-block;}
.status-good{background:rgba(62,207,142,.15);color:var(--green);}
.status-warn{background:rgba(245,166,35,.15);color:var(--orange);}
.status-over{background:rgba(232,93,74,.18);color:var(--red);}
.status-low{background:rgba(79,156,249,.12);color:var(--accent);}
.status-neutral{background:var(--surface2);color:var(--text2);}

.macro-gap{font-size:14px;font-weight:800;display:inline;}
.gap-positive{color:var(--green);font-weight:800;}
.gap-warn{color:var(--orange);font-weight:800;}
.gap-over{color:var(--red);font-weight:800;}
.gap-neutral{color:var(--text2);}

/* â”€â”€ FOOD LIST â”€â”€ */
.food-list-header{display:grid;grid-template-columns:22px 1fr 115px 66px 66px 66px 66px 32px;gap:5px;padding:7px 10px;font-size:11px;color:var(--text2);letter-spacing:1px;text-transform:uppercase;border-bottom:1px solid var(--border);margin-bottom:4px;}
.food-item{display:grid;grid-template-columns:22px 1fr 115px 66px 66px 66px 66px 32px;gap:5px;padding:9px 10px;background:var(--surface);border:1px solid var(--border);border-radius:8px;margin-bottom:5px;align-items:center;transition:border-color .15s;}
.food-item.drag-over{border-color:var(--accent);background:rgba(79,156,249,.06);}
@keyframes slideIn{from{opacity:0;transform:translateY(-4px);}to{opacity:1;transform:translateY(0);}}
.drag-handle{cursor:grab;color:var(--text2);font-size:12px;text-align:center;user-select:none;opacity:.4;}
.drag-handle:hover{opacity:1;}
.food-name{font-size:13px;font-weight:500;cursor:pointer;}
.food-name:hover{color:var(--accent);}
.amount-cell{display:flex;align-items:center;gap:3px;}
.food-amount-input{width:58px;padding:5px 5px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'Heebo',sans-serif;font-size:13px;text-align:center;outline:none;transition:border-color .2s;}
.food-amount-input:focus{border-color:var(--accent);}
.amount-spinners{display:flex;flex-direction:column;gap:2px;}
.spin-btn{background:var(--surface3);border:none;color:var(--text2);cursor:pointer;width:17px;height:13px;border-radius:3px;font-size:8px;display:flex;align-items:center;justify-content:center;transition:all .15s;padding:0;}
.spin-btn:hover{background:var(--accent);color:white;}
.food-unit{font-size:11px;color:var(--text2);white-space:nowrap;}
.food-macro{font-size:13px;font-weight:500;text-align:center;}
.food-cal{color:var(--orange);}
.food-prot{color:var(--accent);}
.food-carb{color:var(--green);}
.food-fat{color:var(--accent2);}
.remove-btn{background:none;border:none;color:var(--text2);cursor:pointer;font-size:14px;padding:3px;border-radius:4px;transition:all .2s;}
.remove-btn:hover{color:var(--red);background:rgba(232,93,74,.1);}

.section-header-item{display:flex;align-items:center;gap:10px;padding:7px 10px;background:rgba(245,208,32,.06);border:1px solid rgba(245,208,32,.22);border-radius:8px;margin-bottom:5px;margin-top:6px;}
.section-header{display:flex;align-items:center;gap:10px;padding:7px 10px;background:rgba(245,208,32,.06);border:1px solid rgba(245,208,32,.22);border-radius:8px;margin-bottom:5px;margin-top:6px;}
.section-header .section-input{flex:1;}
.section-header .delete-btn{margin-right:auto;}
.section-handle{color:rgba(245,208,32,.35);font-size:12px;cursor:grab;user-select:none;}
.section-handle:hover{color:var(--yellow);}
.section-input{flex:1;background:none;border:none;color:var(--yellow);font-family:'Heebo',sans-serif;font-size:13px;font-weight:700;outline:none;}
.section-input::placeholder{color:rgba(245,208,32,.28);font-weight:400;}
.section-remove{background:none;border:none;color:rgba(245,208,32,.25);cursor:pointer;font-size:13px;padding:2px;border-radius:4px;transition:all .2s;}
.section-remove:hover{color:var(--red);}

.add-row{display:flex;gap:8px;margin-top:10px;}
.add-food-btn{flex:1;display:flex;align-items:center;gap:7px;padding:10px 16px;background:var(--surface2);border:1px dashed var(--border);border-radius:8px;color:var(--text2);cursor:pointer;font-family:'Heebo',sans-serif;font-size:13px;font-weight:500;transition:all .2s;}
.add-food-btn:hover{border-color:var(--accent);color:var(--accent);background:rgba(79,156,249,.05);}
.add-section-btn{padding:10px 14px;background:var(--surface2);border:1px dashed rgba(245,208,32,.25);border-radius:8px;color:rgba(245,208,32,.55);cursor:pointer;font-family:'Heebo',sans-serif;font-size:12px;font-weight:500;transition:all .2s;white-space:nowrap;}
.add-section-btn:hover{border-color:var(--yellow);color:var(--yellow);}

.food-selector{background:var(--surface);border:1px solid var(--accent);border-radius:var(--radius);padding:14px;margin-top:8px;}
.food-search{width:100%;padding:9px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'Heebo',sans-serif;font-size:14px;outline:none;margin-bottom:10px;}
.food-search:focus{border-color:var(--accent);}
.food-search::placeholder{color:var(--text2);}
.food-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:7px;max-height:260px;overflow-y:auto;padding-left:3px;}
.food-grid::-webkit-scrollbar{width:4px;}
.food-grid::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
.food-option{padding:9px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:all .15s;}
.food-option:hover{border-color:var(--accent);background:rgba(79,156,249,.08);}
.food-option-name{font-size:13px;font-weight:500;margin-bottom:2px;}
.food-option-info{font-size:11px;color:var(--text2);}

.totals-row{display:grid;grid-template-columns:22px 1fr 115px 66px 66px 66px 66px 32px;gap:5px;padding:9px 10px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;margin-top:8px;font-weight:700;}

/* â”€â”€ CLAUDE BTN â”€â”€ */
.claude-btn{width:100%;padding:13px;background:linear-gradient(135deg,#4f9cf9,#7c5cbf);border:none;border-radius:10px;color:white;font-family:'Heebo',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:opacity .2s;display:flex;align-items:center;justify-content:center;gap:10px;margin-top:16px;}
.claude-btn:hover{opacity:.85;}
.claude-btn:disabled{opacity:.45;cursor:not-allowed;}
.analysis-box{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px 22px;margin-top:14px;white-space:pre-wrap;font-size:14px;line-height:1.8;color:var(--text);}

/* â”€â”€ AMOUNT POPUP (edit only) â”€â”€ */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:900;}
.amount-popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--surface);border:1px solid var(--accent);border-radius:var(--radius);padding:22px;z-index:1000;min-width:290px;box-shadow:0 20px 60px rgba(0,0,0,.5);animation:popIn .18s ease;}
@keyframes popIn{from{opacity:0;transform:translate(-50%,-52%) scale(.97);}to{opacity:1;transform:translate(-50%,-50%) scale(1);}}
.popup-title{font-size:15px;font-weight:700;margin-bottom:3px;}
.popup-default{font-size:12px;color:var(--text2);margin-bottom:14px;}
.popup-input-row{display:flex;gap:10px;align-items:center;}
.popup-amount{flex:1;padding:11px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'Heebo',sans-serif;font-size:18px;font-weight:600;text-align:center;outline:none;}
.popup-amount:focus{border-color:var(--accent);}
.popup-unit{font-size:14px;color:var(--text2);white-space:nowrap;}
.popup-preview{margin-top:12px;padding:11px;background:var(--surface2);border-radius:8px;display:grid;grid-template-columns:repeat(4,1fr);gap:8px;text-align:center;}
.preview-item label{display:block;font-size:10px;color:var(--text2);margin-bottom:2px;text-transform:uppercase;}
.preview-item span{font-size:14px;font-weight:700;font-family:'Rajdhani',sans-serif;}
.popup-actions{display:flex;gap:10px;margin-top:14px;}
.btn-primary{flex:1;padding:11px;background:var(--accent);border:none;border-radius:8px;color:white;font-family:'Heebo',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:opacity .2s;}
.btn-primary:hover{opacity:.85;}
.btn-cancel{padding:11px 18px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text2);font-family:'Heebo',sans-serif;font-size:14px;cursor:pointer;transition:all .2s;}
.btn-cancel:hover{color:var(--text);border-color:var(--text2);}

/* food-option added flash */
@keyframes addFlash{0%{background:rgba(79,156,249,.3);border-color:var(--accent);}100%{background:var(--surface2);border-color:var(--border);}}
.food-option.added{animation:addFlash .5s ease;}

/* â”€â”€ SETTINGS MODAL â”€â”€ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:800;display:none;align-items:center;justify-content:center;}
.modal-overlay.open{display:flex;}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;width:90vw;max-width:1000px;max-height:85vh;display:flex;flex-direction:column;box-shadow:0 30px 80px rgba(0,0,0,.6);animation:popIn .2s ease;}
.modal-header{padding:18px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.modal-title{font-family:'Rajdhani',sans-serif;font-size:18px;font-weight:700;letter-spacing:1.5px;color:var(--accent);}
.modal-close{background:none;border:none;color:var(--text2);cursor:pointer;font-size:20px;padding:4px;border-radius:6px;transition:all .2s;line-height:1;}
.modal-close:hover{color:var(--text);background:var(--surface2);}
.modal-body{flex:1;overflow-y:auto;padding:20px 24px;}
.modal-body::-webkit-scrollbar{width:5px;}
.modal-body::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}

/* DB Table */
.db-table-header{display:grid;grid-template-columns:24px 1.4fr 72px 62px 68px 68px 68px 68px 46px;gap:5px;padding:8px 10px;font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:1px;border-bottom:1px solid var(--border);margin-bottom:4px;align-items:center;}
.db-table-row{display:grid;grid-template-columns:24px 1.4fr 72px 62px 68px 68px 68px 68px 46px;gap:5px;padding:8px 10px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;margin-bottom:4px;align-items:center;transition:border-color .15s;}
.db-table-row:hover{border-color:var(--text2);}
.db-table-row.db-drag-over{border-color:var(--accent);}
.db-drag-handle{cursor:grab;color:var(--text2);font-size:12px;text-align:center;user-select:none;opacity:.4;}
.db-drag-handle:hover{opacity:1;}
/* name cell: show as text, click pencil to edit */
.db-name-wrap{display:flex;align-items:center;gap:5px;min-width:0;}
.db-food-name-cell{font-size:13px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;}
.db-name-input{font-size:13px;font-weight:600;padding:3px 6px;background:var(--surface3);border:1px solid var(--accent);border-radius:5px;color:var(--text);font-family:'Heebo',sans-serif;outline:none;width:100%;display:none;}
.db-name-input.editing{display:block;}
.db-food-name-cell.editing{display:none;}
.db-edit-name-btn{background:none;border:none;color:var(--text2);cursor:pointer;font-size:12px;padding:2px 3px;border-radius:3px;opacity:0;transition:all .15s;flex-shrink:0;}
.db-table-row:hover .db-edit-name-btn{opacity:1;}
.db-edit-name-btn:hover{color:var(--accent);}
.db-input{padding:5px 6px;background:var(--surface3);border:1px solid var(--border);border-radius:5px;color:var(--text);font-family:'Heebo',sans-serif;font-size:12px;outline:none;width:100%;text-align:center;}
.db-input:focus{border-color:var(--accent);}
.db-select{padding:5px 3px;background:var(--surface3);border:1px solid var(--border);border-radius:5px;color:var(--text);font-family:'Heebo',sans-serif;font-size:12px;outline:none;width:100%;}
.db-input.cal:focus{border-color:var(--orange);}
.db-input.prot:focus{border-color:var(--accent);}
.db-input.carb:focus{border-color:var(--green);}
.db-input.fat:focus{border-color:var(--accent2);}
.db-del{background:none;border:none;color:var(--text2);cursor:pointer;font-size:13px;padding:4px;border-radius:4px;transition:all .2s;}
.db-del:hover{color:var(--red);}

/* Add new food row */
.db-add-bar{background:rgba(62,207,142,.06);border:1px dashed var(--green);border-radius:10px;padding:14px 10px;margin-top:14px;}
.db-add-bar-title{font-size:11px;color:var(--green);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;font-weight:700;}
.db-add-row{display:grid;grid-template-columns:1.6fr 80px 68px 68px 68px 68px 68px 90px;gap:5px;align-items:center;}
.db-add-name-input{padding:7px 10px;background:var(--surface2);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:'Heebo',sans-serif;font-size:13px;outline:none;width:100%;}
.db-add-name-input:focus{border-color:var(--green);}
.db-add-name-input::placeholder{color:var(--text2);}
.btn-add-new{padding:7px 14px;background:rgba(62,207,142,.15);border:1px solid var(--green);border-radius:7px;color:var(--green);font-family:'Heebo',sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:all .2s;white-space:nowrap;}
.btn-add-new:hover{background:var(--green);color:var(--bg);}

/* History */
.history-item{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px 18px;margin-bottom:10px;transition:border-color .2s;}
.history-item:hover{border-color:var(--text2);}
.history-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:6px;}
.history-date{font-size:14px;font-weight:700;cursor:pointer;}
.history-date:hover{color:var(--accent);}
.history-type{font-size:11px;padding:3px 10px;border-radius:20px;}
.history-type.rest{background:rgba(62,207,142,.15);color:var(--green);}
.history-type.train{background:rgba(79,156,249,.15);color:var(--accent);}
.history-macros{display:flex;gap:14px;flex-wrap:wrap;margin-bottom:10px;}
.history-macro{font-size:13px;color:var(--text2);}
.history-macro span{font-weight:700;color:var(--text);}
.history-weight-badge{font-size:12px;color:var(--accent2);font-weight:600;padding:2px 8px;background:rgba(124,92,191,.12);border-radius:12px;display:flex;align-items:center;gap:3px;}
.history-actions{display:flex;gap:7px;border-top:1px solid var(--border);padding-top:10px;}
.hist-btn{padding:5px 12px;border-radius:6px;border:1px solid var(--border);background:var(--surface2);color:var(--text2);cursor:pointer;font-family:'Heebo',sans-serif;font-size:12px;font-weight:500;transition:all .2s;display:flex;align-items:center;gap:5px;}
.hist-btn.load:hover{border-color:var(--accent);color:var(--accent);}
.hist-btn.clone:hover{border-color:var(--yellow);color:var(--yellow);}
.hist-btn.del:hover{border-color:var(--red);color:var(--red);}

/* Clone date picker popup */
.clone-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:1001;}
.clone-popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--surface);border:1px solid var(--yellow);border-radius:var(--radius);padding:24px;z-index:1002;min-width:380px;box-shadow:0 20px 60px rgba(0,0,0,.6);animation:popIn .18s ease;}
.clone-popup h3{font-size:16px;font-weight:700;margin-bottom:16px;color:var(--yellow);}
.clone-dates-row{display:flex;align-items:flex-start;gap:12px;}
.clone-date-col{flex:1;display:flex;flex-direction:column;gap:4px;}
.clone-col-label{font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;font-weight:700;margin-bottom:4px;}
.clone-date-input{width:100%;padding:10px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'Heebo',sans-serif;font-size:14px;outline:none;}
.clone-date-input:focus{border-color:var(--yellow);}
.clone-arrow{font-size:22px;color:var(--yellow);padding-top:28px;flex-shrink:0;}
.clone-actions{display:flex;gap:10px;}
.btn-clone-confirm{flex:1;padding:11px;background:var(--yellow);border:none;border-radius:8px;color:var(--bg);font-family:'Heebo',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:opacity .2s;}
.btn-clone-confirm:hover{opacity:.85;}

/* Weight input in today view */
.weight-inline{display:flex;align-items:center;gap:6px;margin-right:auto;padding-right:12px;border-right:1px solid var(--border);}
.weight-label{font-size:14px;color:var(--text2);}
.weight-input{width:75px;padding:9px 8px;background:var(--surface2);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:'Heebo',sans-serif;font-size:14px;font-weight:600;text-align:center;outline:none;}
.weight-input:focus{border-color:var(--accent2);}
.weight-unit{font-size:12px;color:var(--text2);}
.weight-saved-msg{font-size:11px;color:var(--green);opacity:0;transition:opacity .4s;font-weight:700;}
.weight-saved-msg.show{opacity:1;}

/* â”€â”€ STATS TAB â”€â”€ */
.stats-tab{flex:1;overflow-y:auto;padding:20px 28px 28px;}
.stats-tab::-webkit-scrollbar{width:6px;}
.stats-tab::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}

.range-bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:16px;}
.range-btn{padding:8px 16px;border-radius:8px;border:1px solid var(--border);background:var(--surface2);color:var(--text2);cursor:pointer;font-family:'Heebo',sans-serif;font-size:13px;font-weight:500;transition:all .2s;}
.range-btn.active{background:rgba(79,156,249,.15);border-color:var(--accent);color:var(--accent);}
.range-btn:hover:not(.active){border-color:var(--text2);color:var(--text);}
.custom-range{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
.custom-range input[type=date]{padding:7px 10px;background:var(--surface2);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:'Heebo',sans-serif;font-size:13px;outline:none;}
.custom-range input[type=date]:focus{border-color:var(--accent);}
.custom-range button{padding:7px 14px;background:var(--accent);border:none;border-radius:7px;color:white;font-family:'Heebo',sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:opacity .2s;}
.custom-range button:hover{opacity:.85;}
.range-sep{font-size:12px;color:var(--text2);}

.stats-kpis{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:18px;}
.kpi-box{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;text-align:center;}
.kpi-label{font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:1px;margin-bottom:5px;}
.kpi-value{font-family:'Rajdhani',sans-serif;font-size:26px;font-weight:700;line-height:1;}
.kpi-sub{font-size:11px;color:var(--text2);margin-top:3px;}
.kpi-box.days .kpi-value{color:var(--text);}
.kpi-box.kcal .kpi-value{color:var(--orange);}
.kpi-box.prot .kpi-value{color:var(--accent);}
.kpi-box.carb .kpi-value{color:var(--green);}
.kpi-box.wt   .kpi-value{color:var(--accent2);}

.chart-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px 22px;margin-bottom:14px;}
.chart-card-title{font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:1px;font-weight:700;margin-bottom:14px;}
.chart-scroll{overflow-x:auto;}
.chart-svg-wrap{min-width:600px;}

.stats-table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:0;overflow:hidden;margin-bottom:14px;}
.stats-table{width:100%;border-collapse:collapse;font-size:13px;}
.stats-table th{padding:9px 14px;font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:1px;border-bottom:1px solid var(--border);text-align:center;font-weight:700;background:var(--surface2);}
.stats-table th:first-child{text-align:right;}
.stats-table td{padding:9px 14px;border-bottom:1px solid rgba(46,52,84,.4);text-align:center;}
.stats-table td:first-child{text-align:right;font-weight:600;cursor:pointer;}
.stats-table td:first-child:hover{color:var(--accent);}
.stats-table tr:last-child td{border-bottom:none;}
.stats-table tr:hover td{background:rgba(79,156,249,.04);}
.stats-table tfoot td{font-weight:700;background:var(--surface2);border-top:1px solid var(--border);}
.td-cal{color:var(--orange);}
.td-prot{color:var(--accent);}
.td-carb{color:var(--green);}
.td-fat{color:var(--accent2);}
.td-wt{color:var(--accent2);font-weight:600;}
.badge-rest{font-size:10px;padding:2px 6px;background:rgba(62,207,142,.12);color:var(--green);border-radius:10px;display:inline-block;}
.badge-train{font-size:10px;padding:2px 6px;background:rgba(79,156,249,.12);color:var(--accent);border-radius:10px;display:inline-block;}

.empty-state{text-align:center;padding:40px;color:var(--text2);font-size:14px;}

/* â”€â”€ FREE ITEM POPUP â”€â”€ */
.free-item-overlay{position:fixed;inset:0;background:rgba(0,0,0,.58);z-index:1010;}
.free-item-popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--surface);border:1px solid var(--accent2);border-radius:var(--radius);padding:24px;z-index:1011;width:420px;max-width:95vw;box-shadow:0 24px 70px rgba(0,0,0,.6);animation:popIn .18s ease;}
.free-item-popup h3{font-size:15px;font-weight:700;margin-bottom:4px;color:var(--accent2);}
.free-item-popup .fip-sub{font-size:12px;color:var(--text2);margin-bottom:16px;}
.fip-name{width:100%;padding:9px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'Heebo',sans-serif;font-size:14px;outline:none;margin-bottom:12px;}
.fip-name:focus{border-color:var(--accent2);}
.fip-macros{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:12px;}
.fip-macro-field{display:flex;flex-direction:column;gap:3px;}
.fip-macro-field label{font-size:10px;text-transform:uppercase;letter-spacing:.5px;font-weight:700;}
.fip-macro-field.cal label{color:var(--orange);}
.fip-macro-field.prot label{color:var(--accent);}
.fip-macro-field.carb label{color:var(--green);}
.fip-macro-field.fat label{color:var(--accent2);}
.fip-macro-field input{padding:8px 6px;background:var(--surface2);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:'Heebo',sans-serif;font-size:14px;font-weight:600;text-align:center;outline:none;}
.fip-macro-field.cal input:focus{border-color:var(--orange);}
.fip-macro-field.prot input:focus{border-color:var(--accent);}
.fip-macro-field.carb input:focus{border-color:var(--green);}
.fip-macro-field.fat input:focus{border-color:var(--accent2);}
.fip-claude-area{background:var(--surface2);border:1px solid var(--border);border-radius:9px;padding:12px;margin-bottom:12px;}
.fip-claude-label{font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;font-weight:700;}
.fip-desc{width:100%;padding:8px 10px;background:var(--surface3);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:'Heebo',sans-serif;font-size:13px;outline:none;resize:none;height:54px;line-height:1.4;}
.fip-desc:focus{border-color:var(--accent2);}
.fip-desc::placeholder{color:var(--text2);}
.fip-estimate-btn{width:100%;margin-top:7px;padding:8px;background:linear-gradient(135deg,rgba(79,156,249,.2),rgba(124,92,191,.2));border:1px solid var(--accent2);border-radius:7px;color:var(--accent2);font-family:'Heebo',sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:7px;}
.fip-estimate-btn:hover{background:linear-gradient(135deg,rgba(79,156,249,.3),rgba(124,92,191,.3));}
.fip-estimate-btn:disabled{opacity:.45;cursor:not-allowed;}
.fip-actions{display:flex;gap:10px;}
.fip-add-btn{flex:1;padding:11px;background:var(--accent2);border:none;border-radius:8px;color:white;font-family:'Heebo',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:opacity .2s;}
.fip-add-btn:hover{opacity:.85;}

/* free item badge in food list */
.free-item-badge{font-size:9px;background:rgba(124,92,191,.2);color:var(--accent2);padding:1px 5px;border-radius:4px;font-weight:700;margin-right:4px;vertical-align:middle;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE â€” MOBILE (<768px)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

</style>
</head>
<body>

<!-- â•â• HEADER â•â• -->
<div class="header">
  <span class="header-title">NUTRITION TRACKER</span>
  <div class="header-right">
    <span class="header-date" id="headerDate"></span>
    <span id="syncStatus" style="font-size:11px;color:var(--text2);transition:color .3s;"></span>
    <button class="settings-btn" onclick="openSettings()">âš™ ×˜×‘×œ×ª ×™×¡×•×“</button>
  </div>
</div>

<!-- â•â• TABS â•â• -->
<div class="tabs">
  <div class="tab active" data-tab="today" onclick="switchTab('today')">×”×™×•×</div>
  <div class="tab" data-tab="history" onclick="switchTab('history')">×”×™×¡×˜×•×¨×™×”</div>
  <div class="tab" data-tab="stats" onclick="switchTab('stats')">ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×•×ª</div>
  <div class="tab" data-tab="notes" onclick="switchTab('notes')">ğŸ“ ×¨×¢×™×•× ×•×ª ×•×©×•× ×•×ª</div>
</div>

<!-- â•â• TODAY TAB â•â• -->
<div id="tab-today" style="display:flex;flex-direction:column;flex:1;overflow:hidden;min-height:0;">

  <!-- STICKY TOP -->
  <div class="sticky-top">
    <div class="card" style="margin-bottom:12px;">
      <div class="card-title">×”×’×“×¨×ª ×™×•×</div>
      <div class="day-setup">
        <input type="date" class="date-input" id="dayDate" onchange="onDateChange()" />
        <button class="day-type-btn active-rest" id="btn-rest" onclick="setDayType('rest')">ğŸ˜´ ×™×•× ×× ×•×—×” â€” 1,650 ×§×œ×³</button>
        <button class="day-type-btn" id="btn-train" onclick="setDayType('train')">ğŸ’ª ×™×•× ××™××•×Ÿ â€” 1,975 ×§×œ×³</button>
        <div class="weight-inline">
          <span class="weight-label">âš–</span>
          <input type="number" class="weight-input" id="weightInput" placeholder="××©×§×œ" step="0.1" min="30" max="200" oninput="saveWeight()" />
          <span class="weight-unit">×§×´×’</span>
          <span class="weight-saved-msg" id="weightSavedMsg">âœ“</span>
        </div>
      </div>
    </div>

    <div class="macros-bar">
      <!-- Calories -->
      <div class="macro-card cal">
        <div class="macro-label">×§×œ×•×¨×™×•×ª</div>
        <div class="macro-top">
          <div>
            <div class="macro-value" id="totalCal">0</div>
            <div class="macro-unit">×§×œ×³</div>
          </div>
          <div style="text-align:left;">
            <div class="macro-status status-neutral" id="statusCal">â€”</div>
          </div>
        </div>
        <div class="macro-target-row"><div class="macro-target" id="targetCal">×™×¢×“: 1,650</div><div class="macro-gap" id="gapCal"></div></div>
        <div class="macro-progress"><div class="macro-progress-fill" id="progCal" style="width:0%"></div></div>
      </div>
      <!-- Protein -->
      <div class="macro-card protein">
        <div class="macro-label">×—×œ×‘×•×Ÿ</div>
        <div class="macro-top">
          <div>
            <div class="macro-value" id="totalProt">0</div>
            <div class="macro-unit">×’×¨×</div>
          </div>
          <div style="text-align:left;">
            <div class="macro-status status-neutral" id="statusProt">â€”</div>
          </div>
        </div>
        <div class="macro-target-row"><div class="macro-target">×™×¢×“: 130â€“150 ×’×¨×</div><div class="macro-gap" id="gapProt"></div></div>
        <div class="macro-progress"><div class="macro-progress-fill" id="progProt" style="width:0%"></div></div>
      </div>
      <!-- Carbs -->
      <div class="macro-card carbs">
        <div class="macro-label">×¤×—××™××•×ª</div>
        <div class="macro-top">
          <div>
            <div class="macro-value" id="totalCarb">0</div>
            <div class="macro-unit">×’×¨×</div>
          </div>
          <div style="text-align:left;">
            <div class="macro-status status-neutral" id="statusCarb">â€”</div>
          </div>
        </div>
        <div class="macro-target-row"><div class="macro-target">×™×¢×“: 150â€“200 ×’×¨×</div><div class="macro-gap" id="gapCarb"></div></div>
        <div class="macro-progress"><div class="macro-progress-fill" id="progCarb" style="width:0%"></div></div>
      </div>
      <!-- Fat -->
      <div class="macro-card fat">
        <div class="macro-label">×©×•×× ×™×</div>
        <div class="macro-top">
          <div>
            <div class="macro-value" id="totalFat">0</div>
            <div class="macro-unit">×’×¨×</div>
          </div>
          <div style="text-align:left;">
            <div class="macro-status status-neutral" id="statusFat">â€”</div>
          </div>
        </div>
        <div class="macro-target-row"><div class="macro-target">×™×¢×“: 40â€“60 ×’×¨×</div><div class="macro-gap" id="gapFat"></div></div>
        <div class="macro-progress"><div class="macro-progress-fill" id="progFat" style="width:0%"></div></div>
      </div>
    </div><!-- /macros-bar -->
  </div><!-- /sticky-top -->

  <!-- SCROLL AREA -->
  <div class="scroll-area">
    <div class="card">
      <div class="card-title">××¨×•×—×•×ª ×”×™×•×</div>
      <div class="food-list-header">
        <div></div><div>××–×•×Ÿ</div><div style="text-align:center">×›××•×ª</div>
        <div style="text-align:center">×§×œ×³</div><div style="text-align:center">×—×œ×‘×•×Ÿ</div>
        <div style="text-align:center">×¤×—××™××•×ª</div><div style="text-align:center">×©×•×× ×™×</div><div></div>
      </div>
      <div id="foodItemsList"><div class="empty-state">×˜×¨× ×”×•×¡×¤×ª ××–×•× ×•×ª ×œ×”×™×•×</div></div>
      <div class="totals-row" id="totalsRow" style="display:none">
        <div></div><div>×¡×”×´×›</div><div></div>
        <div class="food-cal" style="text-align:center" id="sumCal">0</div>
        <div class="food-prot" style="text-align:center" id="sumProt">0</div>
        <div class="food-carb" style="text-align:center" id="sumCarb">0</div>
        <div class="food-fat" style="text-align:center" id="sumFat">0</div>
        <div></div>
      </div>
      <div class="add-row">
        <button class="add-food-btn" onclick="toggleFoodSelector()"><span style="font-size:17px">+</span> ×”×•×¡×£ ××–×•×Ÿ</button>
        <button class="add-section-btn" onclick="addSectionHeader()">ğŸ“Œ ×›×•×ª×¨×ª ×‘×™× ×™×™×</button>
      </div>
      <div class="food-selector" id="foodSelector" style="display:none">
        <input type="text" class="food-search" placeholder="ğŸ” ×—×¤×© ××–×•×Ÿ..." id="foodSearch" oninput="filterFoods()" />
        <div class="food-grid" id="foodGrid"></div>
        <div style="border-top:1px solid var(--border);margin-top:10px;padding-top:10px;">
          <button onclick="openFreeItemPopup(null)" style="width:100%;padding:10px 14px;background:rgba(124,92,191,.1);border:1px dashed var(--accent2);border-radius:8px;color:var(--accent2);font-family:'Heebo',sans-serif;font-size:13px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all .2s;"
            onmouseover="this.style.background='rgba(124,92,191,.2)'" onmouseout="this.style.background='rgba(124,92,191,.1)'">
            âœ ×¤×¨×™×˜ ×˜×§×¡×˜ ×—×•×¤×©×™ â€” ×”×–×Ÿ ×¢×¨×›×™× ×™×“× ×™×ª / ×”×¢×¨×›×ª Claude
          </button>
        </div>
      </div>
    </div>

    <button class="claude-btn" id="claudeBtn" onclick="analyzeWithClaude()" disabled>
      <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l3 3"/></svg>
      ×‘×§×© × ×™×ª×•×— ××§×œ×•×“
    </button>
    <div id="analysisBox" style="display:none"></div>
  </div>

</div><!-- /tab-today -->

<!-- â•â• HISTORY TAB â•â• -->
<div id="tab-history" style="display:none;flex:1;overflow-y:auto;padding:20px 28px;">
  <div class="card">
    <div class="card-title">×™××™× ×§×•×“××™×</div>
    <div id="historyList"><div class="empty-state">××™×Ÿ ×”×™×¡×˜×•×¨×™×” ×¢×“×™×™×Ÿ</div></div>
  </div>
</div>

<!-- â•â• STATS TAB â•â• -->
<div id="tab-stats" class="stats-tab" style="display:none;">
  <div class="card" style="margin-bottom:16px;">
    <div class="card-title">×˜×•×•×— ×ª××¨×™×›×™×</div>
    <div class="range-bar">
      <button class="range-btn active" onclick="setRange(7,this)">7 ×™××™×</button>
      <button class="range-btn" onclick="setRange(14,this)">14 ×™××™×</button>
      <button class="range-btn" onclick="setRange(30,this)">30 ×™××™×</button>
      <div class="custom-range">
        <span class="range-sep">××• ×‘×—×¨:</span>
        <input type="date" id="statsFrom" />
        <span class="range-sep">×¢×“</span>
        <input type="date" id="statsTo" />
        <button onclick="applyCustomRange()">×”×¦×’</button>
      </div>
    </div>
  </div>

  <div class="stats-kpis" id="statsKpis">
    <div class="kpi-box days"><div class="kpi-label">×™××™×</div><div class="kpi-value" id="kpiDays">â€”</div><div class="kpi-sub">×¢× × ×ª×•× ×™×</div></div>
    <div class="kpi-box kcal"><div class="kpi-label">×§×œ×³ ×××•×¦×¢</div><div class="kpi-value" id="kpiCal">â€”</div><div class="kpi-sub">×§×œ×³ / ×™×•×</div></div>
    <div class="kpi-box prot"><div class="kpi-label">×—×œ×‘×•×Ÿ ×××•×¦×¢</div><div class="kpi-value" id="kpiProt">â€”</div><div class="kpi-sub">×’×¨× / ×™×•×</div></div>
    <div class="kpi-box carb"><div class="kpi-label">×¤×—××™××•×ª ×××•×¦×¢</div><div class="kpi-value" id="kpiCarb">â€”</div><div class="kpi-sub">×’×¨× / ×™×•×</div></div>
    <div class="kpi-box wt"><div class="kpi-label">×©×™× ×•×™ ××©×§×œ</div><div class="kpi-value" id="kpiWeight">â€”</div><div class="kpi-sub" id="kpiWeightSub">×§×´×’ ×‘×˜×•×•×—</div></div>
  </div>

  <div class="chart-card">
    <div class="chart-card-title">×§×œ×•×¨×™×•×ª ×•××©×§×œ ×œ××•×¨×š ×–××Ÿ</div>
    <div class="chart-scroll">
      <div class="chart-svg-wrap" id="chartSvgWrap"></div>
    </div>
  </div>

  <div class="stats-table-wrap">
    <table class="stats-table">
      <thead>
        <tr>
          <th>×ª××¨×™×š</th>
          <th>×¡×•×’ ×™×•×</th>
          <th>×§×œ×³</th>
          <th>×—×œ×‘×•×Ÿ</th>
          <th>×¤×—××™××•×ª</th>
          <th>×©×•×× ×™×</th>
          <th>××©×§×œ ×§×´×’</th>
        </tr>
      </thead>
      <tbody id="statsTableBody"></tbody>
      <tfoot id="statsTableFoot"></tfoot>
    </table>
  </div>
</div>

<!-- â•â• NOTES TAB â•â• -->
<div id="tab-notes" style="display:none;flex:1;overflow-y:auto;padding:20px 28px 28px;">
  <div class="card" style="height:calc(100% - 40px);display:flex;flex-direction:column;">
    <div class="card-title" style="margin-bottom:10px;">ğŸ“ ×¨×¢×™×•× ×•×ª ×•×©×•× ×•×ª â€” ×ª×–×›×•×¨×•×ª, ×˜×™×¤×™×, ××¡×§× ×•×ª</div>
    <textarea id="notesTextarea"
      placeholder="×›×ª×•×‘ ×›××Ÿ ×›×œ ××” ×©×¢×•×œ×” ×œ×š ×‘×¨××©...&#10;&#10;×¨×¢×™×•× ×•×ª ×œ××¨×•×—×•×ª, ×ª×–×›×•×¨×•×ª, ××¡×§× ×•×ª ××”×©×‘×•×¢, ×˜×™×¤×™× ×©×œ××“×ª, ×©××œ×•×ª ×œ×¨×•×¤×, ××” ×¢×‘×“ ×•××” ×œ×..."
      oninput="saveNotes()"
      style="flex:1;width:100%;min-height:500px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:'Heebo',sans-serif;font-size:15px;line-height:1.8;padding:18px 20px;outline:none;resize:none;direction:rtl;"></textarea>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;">
      <span id="notesSavedMsg" style="font-size:12px;color:var(--green);opacity:0;transition:opacity .4s;font-weight:600;">âœ“ × ×©××¨</span>
      <span id="notesCharCount" style="font-size:11px;color:var(--text2);"></span>
    </div>
  </div>
</div>
<div class="overlay" id="overlay" style="display:none" onclick="closeAmountPopup()"></div>
<div class="amount-popup" id="amountPopup" style="display:none">
  <div class="popup-title" id="popupFoodName"></div>
  <div class="popup-default" id="popupDefault"></div>
  <div class="popup-input-row">
    <input type="number" class="popup-amount" id="popupAmount" oninput="updatePreview()" step="5" />
    <span class="popup-unit" id="popupUnit"></span>
  </div>
  <div class="popup-preview">
    <div class="preview-item"><label>×§×œ×•×¨×™×•×ª</label><span class="food-cal" id="previewCal">0</span></div>
    <div class="preview-item"><label>×—×œ×‘×•×Ÿ</label><span class="food-prot" id="previewProt">0</span></div>
    <div class="preview-item"><label>×¤×—××™××•×ª</label><span class="food-carb" id="previewCarb">0</span></div>
    <div class="preview-item"><label>×©×•×× ×™×</label><span class="food-fat" id="previewFat">0</span></div>
  </div>
  <div class="popup-actions">
    <button class="btn-primary" onclick="confirmAddFood()">×¢×“×›×Ÿ ×›××•×ª</button>
    <button class="btn-cancel" onclick="closeAmountPopup()">×‘×™×˜×•×œ</button>
  </div>
</div>

<!-- â•â• FREE ITEM POPUP â•â• -->
<div class="free-item-overlay" id="freeItemOverlay" style="display:none" onclick="closeFreeItemPopup()"></div>
<div class="free-item-popup" id="freeItemPopup" style="display:none">
  <h3>âœ ×¤×¨×™×˜ ×˜×§×¡×˜ ×—×•×¤×©×™</h3>
  <p class="fip-sub">×”×–×Ÿ ×¢×¨×›×™× ×™×“× ×™×ª, ××• ×ª××¨ ××ª ×”××–×•×Ÿ ×•×§×œ×•×“ ×™×¢×¨×™×š</p>
  <input type="text" class="fip-name" id="fipName" placeholder="×©× ×”××–×•×Ÿ..." />
  <div class="fip-macros">
    <div class="fip-macro-field cal"><label>×§×œ×•×¨×™×•×ª</label><input type="number" id="fipCal" placeholder="0" min="0" step="1" /></div>
    <div class="fip-macro-field prot"><label>×—×œ×‘×•×Ÿ ×’×³</label><input type="number" id="fipProt" placeholder="0" min="0" step="0.5" /></div>
    <div class="fip-macro-field carb"><label>×¤×—××™××•×ª ×’×³</label><input type="number" id="fipCarb" placeholder="0" min="0" step="0.5" /></div>
    <div class="fip-macro-field fat"><label>×©×•××Ÿ ×’×³</label><input type="number" id="fipFat" placeholder="0" min="0" step="0.5" /></div>
  </div>
  <div class="fip-claude-area">
    <div class="fip-claude-label">ğŸ¤– ×”×¢×¨×›×” ×¢× Claude</div>
    <textarea class="fip-desc" id="fipDesc" placeholder="×ª××¨ ××ª ×”××–×•×Ÿ: ×œ××©×œ '×§×¦×™×¦×ª ×‘×©×¨ ×‘×™× ×•× ×™×ª ×‘×™×ª×™×ª, 120 ×’×¨×' ××• '×¦×œ×—×ª ×¤×¡×˜×” ×¢× ×¨×•×˜×‘ ×¢×’×‘× ×™×•×ª'"  ></textarea>
    <button class="fip-estimate-btn" id="fipEstimateBtn" onclick="estimateWithClaude()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l3 3"/></svg>
      ×”×¢×¨×š ×¢×¨×›×™× ×ª×–×•× ×ª×™×™×
    </button>
  </div>
  <div class="fip-actions">
    <button class="fip-add-btn" onclick="confirmFreeItem()">+ ×”×•×¡×£ ×œ×¨×©×™××”</button>
    <button class="btn-cancel" onclick="closeFreeItemPopup()">×‘×™×˜×•×œ</button>
  </div>
</div>

<!-- â•â• CLONE POPUP â•â• -->
<div class="clone-overlay" id="cloneOverlay" style="display:none" onclick="closeClonePopup()"></div>
<div class="clone-popup" id="clonePopup" style="display:none">
  <h3>ğŸ“‹ ×©×›×¤×•×œ ×™×•×</h3>
  <div class="clone-dates-row">
    <div class="clone-date-col">
      <label class="clone-col-label">×©×›×¤×œ ××™×•×:</label>
      <input type="date" class="clone-date-input" id="cloneSourceDate" onchange="updateCloneSourceLabel()" />
      <div class="clone-col-sublabel" id="cloneSourceName" style="color:var(--text2);font-size:11px;margin-top:4px;min-height:16px;"></div>
    </div>
    <div class="clone-arrow">â†’</div>
    <div class="clone-date-col">
      <label class="clone-col-label">×œ×™×•×:</label>
      <input type="date" class="clone-date-input" id="cloneTargetDate" />
      <div class="clone-col-sublabel" style="color:var(--text2);font-size:11px;margin-top:4px;min-height:16px;">×™×•× ×”×™×¢×“</div>
    </div>
  </div>
  <div class="clone-actions" style="margin-top:16px;">
    <button class="btn-clone-confirm" onclick="confirmClone()">âœ“ ×‘×¦×¢ ×©×›×¤×•×œ</button>
    <button class="btn-cancel" onclick="closeClonePopup()">×‘×™×˜×•×œ</button>
  </div>
</div>

<!-- â•â• SETTINGS MODAL â•â• -->
<div class="modal-overlay" id="settingsOverlay" onclick="closeSettingsOutside(event)">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title">âš™ ×˜×‘×œ×ª ×™×¡×•×“ â€” ××–×•× ×•×ª</span>
      <div style="display:flex;gap:10px;align-items:center;">
        <button onclick="resetFoodsToDefault()" style="padding:6px 12px;background:rgba(232,93,74,.12);border:1px solid var(--red);border-radius:7px;color:var(--red);font-family:'Heebo',sans-serif;font-size:12px;cursor:pointer;transition:all .2s;" onmouseover="this.style.opacity='.7'" onmouseout="this.style.opacity='1'">â†º ××¤×¡ ×œ×‘×¨×™×¨×ª ××—×“×œ</button>
        <button class="modal-close" onclick="closeSettings()">âœ•</button>
      </div>
    </div>
    <div class="modal-body">
      <div class="db-table-header" style="grid-template-columns:24px 1.4fr 72px 62px 68px 68px 68px 68px 46px;">
        <div></div>
        <div>×©× ××–×•×Ÿ <span style="font-size:9px;opacity:.6">(×œ×—×¥ âœ ×œ×¢×¨×™×›×”)</span></div>
        <div style="text-align:center">×‘×¨×™×¨×ª ××—×“×œ</div>
        <div style="text-align:center">×™×—×™×“×”</div>
        <div style="text-align:center;color:var(--orange)">×§×œ×³ <span style="font-size:9px;opacity:.7">(×œ-100/×™×—×³)</span></div>
        <div style="text-align:center;color:var(--accent)">×—×œ×‘×•×Ÿ</div>
        <div style="text-align:center;color:var(--green)">×¤×—××™××•×ª</div>
        <div style="text-align:center;color:var(--accent2)">×©×•××Ÿ</div>
        <div></div>
      </div>
      <div id="dbTableRows"></div>

      <!-- Add new -->
      <div class="db-add-bar">
        <div class="db-add-bar-title">+ ×”×•×¡×£ ××–×•×Ÿ ×—×“×©</div>
        <div class="db-add-row">
          <input class="db-add-name-input" type="text" id="newFoodName" placeholder="×©× ×”××–×•×Ÿ..." />
          <input class="db-input" type="number" id="newFoodDefault" value="100" step="5" placeholder="100" />
          <select class="db-select" id="newFoodUnit">
            <option>×’×¨×</option><option>×™×—×™×“×”</option><option>×× ×”</option><option>×›×•×¡</option>
          </select>
          <input class="db-input cal" type="number" id="newFoodCal" placeholder="×§×œ×³" />
          <input class="db-input prot" type="number" id="newFoodProt" placeholder="×—×œ×‘×•×Ÿ" step="0.1" />
          <input class="db-input carb" type="number" id="newFoodCarb" placeholder="×¤×—××™××•×ª" step="0.1" />
          <input class="db-input fat" type="number" id="newFoodFat" placeholder="×©×•××Ÿ" step="0.1" />
          <button class="btn-add-new" onclick="addNewFood()">+ ×”×•×¡×£</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUPABASE CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SUPA_URL='https://klyndyhhelhnebknrvax.supabase.co';
const SUPA_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtseW5keWhoZWxobmVia25ydmF4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0MzkwMDEsImV4cCI6MjA4NzAxNTAwMX0.NK2EbloKx7_Uoge26oFnYGXq6ooiLsd_e3KyACxbm1s';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DEFAULT FOOD DATABASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DEFAULT_FOODS = [
  {id:1,  name:'×©×™×‘×•×œ×ª ×©×•×¢×œ',                             per100:{cal:37,  prot:1.4, carb:6.6,  fat:0.7},  defaultAmount:100, unit:'×’×¨×'},
  {id:2,  name:"×¦'×™×”",                                    per100:{cal:486, prot:17.0,carb:42.0, fat:31.0}, defaultAmount:10,  unit:'×’×¨×'},
  {id:3,  name:'×¤×©×ª×Ÿ ×˜×—×•×Ÿ',                               per100:{cal:534, prot:18.0,carb:29.0, fat:42.0}, defaultAmount:10,  unit:'×’×¨×'},
  {id:4,  name:'××’×•×–×™ ×‘×¨×–×™×œ',                             per100:{cal:659, prot:14.3,carb:12.0, fat:67.0}, defaultAmount:24,  unit:'×’×¨×'},
  {id:5,  name:'×ª×¤×•×—×™ ××“××” ×‘××™×§×¨×•',                      per100:{cal:77,  prot:2.0, carb:17.0, fat:0.1},  defaultAmount:200, unit:'×’×¨×'},
  {id:6,  name:'×—×–×” ×¢×•×£ ×¢×œ ×”×¤×œ× ×¦×³×”',                    per100:{cal:165, prot:31.0,carb:0.0,  fat:3.6},  defaultAmount:150, unit:'×’×¨×'},
  {id:7,  name:"××¢×“×Ÿ ×—×œ×‘×•×Ÿ (63 ×§×œ' / 10 ×’' ×—×œ×‘×•×Ÿ)",      per100:{cal:63,  prot:10.0,carb:3.2,  fat:1.0},  defaultAmount:200, unit:'×’×¨×'},
  {id:8,  name:'×§×•×œ×•×¨×‘×™ ×’×“×•×œ',                            perUnit:{cal:43,  prot:2.7, carb:10.0, fat:0.2},  defaultAmount:2,   unit:'×™×—×™×“×”'},
  {id:9,  name:"×˜×—×™× ×” ×“×œ×ª ×©×•××Ÿ (349 ×§×œ' / 100 ×’×¨×)",     per100:{cal:349, prot:12.3,carb:6.5,  fat:30.4}, defaultAmount:50,  unit:'×’×¨×'},
  {id:10, name:"×˜×—×™× ×” (699 ×§×œ' / 100 ×’×¨×)",               per100:{cal:699, prot:20.5,carb:13.3, fat:62.8}, defaultAmount:10,  unit:'×’×¨×'},
  {id:11, name:"××©×§×” ××•×¨×– ×©×§×“×™× (63 ×§×œ' / 100 ×\"×œ)",    per100:{cal:63,  prot:0.6, carb:10.5, fat:2.0},  defaultAmount:200, unit:'×’×¨×'},
  {id:12, name:"×˜×•× ×” ×‘××™× (116 ×§×œ' / 100 ×’×¨×)",           per100:{cal:116, prot:26.0,carb:0.0,  fat:0.8},  defaultAmount:100, unit:'×’×¨×'},
  {id:13, name:"×“×‘×© (320 ×§×œ' / 100 ×’×¨×)",                 per100:{cal:320, prot:0.0, carb:80.0, fat:0.0},  defaultAmount:10,  unit:'×’×¨×'},
  {id:14, name:'6 ××œ×¤×¤×•× ×™× ×§×˜× ×™× + 2 ×©×•××¨ ×§×˜× ×™×',        perUnit:{cal:65,  prot:2.8, carb:9.2,  fat:0.8},  defaultAmount:1,   unit:'×× ×”'},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let FOODS=[], dayType='rest', currentItems=[], selectedFood=null, editingItemIndex=null;
let dbDragSrc=null, listDragSrc=null;
const TARGETS={
  rest: {cal:1650, protMin:130,protMax:150, carbMin:150,carbMax:200, fatMin:40,fatMax:60},
  train:{cal:1975, protMin:130,protMax:150, carbMin:150,carbMax:200, fatMin:40,fatMax:60},
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded',()=>{
  loadFoodsDB();
  const t=new Date();
  document.getElementById('dayDate').value=t.toISOString().split('T')[0];
  document.getElementById('headerDate').textContent=t.toLocaleDateString('he-IL',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  renderFoodGrid();
  loadDraft().then(()=>updateNotTodayBanner());
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FOODS DB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function sbGet(table,q=''){
  const r=await fetch(`${SUPA_URL}/rest/v1/${table}?${q}`,{headers:{'apikey':SUPA_KEY,'Authorization':'Bearer '+SUPA_KEY}});
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}
async function sbUpsert(table,data){
  console.log(`[UPSERT] ${table} date=${data.date}`);
  // Try PATCH first (update existing), then POST (insert new)
  const patchUrl=`${SUPA_URL}/rest/v1/${table}?date=eq.${data.date}`;
  const patchR=await fetch(patchUrl,{
    method:'PATCH',
    headers:{'apikey':SUPA_KEY,'Authorization':'Bearer '+SUPA_KEY,'Content-Type':'application/json','Prefer':'return=minimal'},
    body:JSON.stringify(data)
  });
  if(patchR.ok){
    // Check if any row was updated
    const count=patchR.headers.get('content-range');
    if(count && count!=='*/0' && count!=='-/-'){
      console.log(`[PATCH OK] ${table} date=${data.date}`);
      return;
    }
  }
  // No existing row â€” INSERT
  const postR=await fetch(`${SUPA_URL}/rest/v1/${table}`,{
    method:'POST',
    headers:{'apikey':SUPA_KEY,'Authorization':'Bearer '+SUPA_KEY,'Content-Type':'application/json','Prefer':'return=minimal'},
    body:JSON.stringify(data)
  });
  if(!postR.ok){
    const err=await postR.text();
    console.error(`[UPSERT ERROR]`,err);
    throw new Error(err);
  }
  console.log(`[INSERT OK] ${table} date=${data.date}`);
}
async function sbDelete(table,q){
  console.log(`[DELETE] ${table}?${q}`);
  const r=await fetch(`${SUPA_URL}/rest/v1/${table}?${q}`,{method:'DELETE',headers:{'apikey':SUPA_KEY,'Authorization':'Bearer '+SUPA_KEY,'Prefer':'return=representation'}});
  const txt=await r.text();
  if(!r.ok){console.error(`[DELETE ERROR] ${txt}`); throw new Error(txt);}
  console.log(`[DELETE OK] response:`,txt);
}
function setSyncStatus(s){
  const el=document.getElementById('syncStatus'); if(!el) return;
  const m={ok:'â˜ ××¡×•× ×›×¨×Ÿ',saving:'â³ ×©×•××¨...',error:'âš  ×©×’×™××”',offline:'ğŸ“´ ×œ× ××—×•×‘×¨'};
  const c={ok:'var(--green)',saving:'var(--text2)',error:'var(--orange)',offline:'var(--text2)'};
  el.textContent=m[s]||''; el.style.color=c[s]||'var(--text2)';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STORAGE â€” FOODS DB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _foodsRowId=null;
async function loadFoodsDB(){
  try{
    const rows=await sbGet('foods_db','select=id,foods&order=updated_at.desc&limit=1');
    if(rows&&rows.length&&rows[0].foods&&rows[0].foods.length){
      _foodsRowId=rows[0].id; FOODS=rows[0].foods;
      migrateFoodsDB();
      localStorage.setItem('foodsDB',JSON.stringify(FOODS)); return;
    }
  }catch(e){ console.warn('foods load',e); }
  try{ const s=JSON.parse(localStorage.getItem('foodsDB')); if(s&&s.length){FOODS=s; migrateFoodsDB(); return;} }catch(e){}
  FOODS=JSON.parse(JSON.stringify(DEFAULT_FOODS));
  await saveFoodsDB();
}
// ××¢×“×›×Ÿ ×¤×¨×™×˜×™× ×™×©× ×™× ×©×—×¡×¨ ×œ×”× ××‘× ×” ×ª×§×™×Ÿ â€” ×-DEFAULT_FOODS
function migrateFoodsDB(){
  let changed=false;
  FOODS.forEach(f=>{
    const def=DEFAULT_FOODS.find(d=>d.id===f.id||d.name===f.name);
    if(!def) return;
    // ×× ×‘-DEFAULT ×™×© perUnit ××‘×œ ×”×¤×¨×™×˜ ×”× ×•×›×—×™ ×œ× ×¢×•×“×›×Ÿ
    if(def.perUnit && !f.perUnit && f.gramsPerUnit){
      f.perUnit=def.perUnit; delete f.per100; delete f.gramsPerUnit; changed=true;
    }
    // ×”×¡×¨ gramsPerUnit ×™×©×Ÿ ×©×›×‘×¨ ×œ× ×¦×¨×™×š
    if(f.gramsPerUnit){ delete f.gramsPerUnit; changed=true; }
  });
  if(changed) saveFoodsDB();
}
async function resetFoodsToDefault(){
  if(!confirm('×œ××¤×¡ ××ª ×›×œ ×˜×‘×œ×ª ×”××–×•× ×•×ª ×œ×‘×¨×™×¨×ª ××—×“×œ? ×›×œ ×”×©×™× ×•×™×™× ×©×œ×š ×™×™××—×§×•.')) return;
  FOODS=JSON.parse(JSON.stringify(DEFAULT_FOODS));
  await saveFoodsDB();
  renderDbTable(); renderFoodGrid();
  alert('âœ“ ×˜×‘×œ×ª ×”××–×•× ×•×ª ××•×¤×¡×”');
}
async function saveFoodsDB(){
  localStorage.setItem('foodsDB',JSON.stringify(FOODS));
  try{
    if(!_foodsRowId){ const rows=await sbGet('foods_db','select=id&limit=1'); if(rows&&rows.length) _foodsRowId=rows[0].id; }
    const data=_foodsRowId?{id:_foodsRowId,foods:FOODS,updated_at:new Date().toISOString()}:{foods:FOODS,updated_at:new Date().toISOString()};
    await sbUpsert('foods_db',data);
  }catch(e){ console.warn('foods save',e); }
}
function getFoodById(id){ return FOODS.find(f=>f.id===id); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STORAGE â€” DRAFT / SAVE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _saveDraftTimer=null;
function saveDraft(){
  const date=document.getElementById('dayDate').value;
  // snapshot current state â€” prevent timer from using stale globals
  const itemsSnap=JSON.parse(JSON.stringify(currentItems));
  const typeSnap=dayType;
  localStorage.setItem('draft_today',JSON.stringify({date,dayType:typeSnap,items:itemsSnap}));
  setSyncStatus('saving');
  clearTimeout(_saveDraftTimer);
  _saveDraftTimer=setTimeout(()=>_persistDay(date,itemsSnap,typeSnap),1200);
}
async function _persistDay(date,items,dt){
  if(!date) return;
  // use passed snapshot, fallback to globals only if called directly
  const _items = items!==undefined ? items : currentItems;
  const _dt = dt!==undefined ? dt : dayType;
  const _t = _items.reduce((a,i)=>{
    const m=calcMacros(i);
    a.cal+=m.cal;a.prot+=m.prot;a.carb+=m.carb;a.fat+=m.fat;return a;
  },{cal:0,prot:0,carb:0,fat:0});
  const w=parseFloat(document.getElementById('weightInput').value)||null;
  try{
    await sbUpsert('days',{date,day_type:_dt,items:_items,totals:_t,weight:w,updated_at:new Date().toISOString()});
    setSyncStatus('ok');
    _saveToLocalHistory(date,_dt,_items,_t);
  }catch(e){ setSyncStatus('error'); console.warn('day save',e); }
}
async function saveToHistory(){ await _persistDay(document.getElementById('dayDate').value,JSON.parse(JSON.stringify(currentItems)),dayType); }
function _saveToLocalHistory(date,dt,items,t){
  const h=JSON.parse(localStorage.getItem('history')||'[]');
  const ex=h.findIndex(x=>x.date===date);
  const entry={date,dayType:dt,items,totals:t};
  if(ex>=0) h[ex]=entry; else h.unshift(entry);
  h.sort((a,b)=>b.date.localeCompare(a.date));
  localStorage.setItem('history',JSON.stringify(h));
}
async function loadDraft(){
  const today=getTodayStr();
  document.getElementById('dayDate').value=today;
  document.getElementById('dayDate')._prevDate=today;
  // try Supabase first
  try{
    const rows=await sbGet('days',`select=*&date=eq.${today}&limit=1`);
    if(rows&&rows.length){
      const r=rows[0]; dayType=r.day_type||'rest'; currentItems=r.items||[];
      refreshItemMacros();
      if(r.weight){ document.getElementById('weightInput').value=r.weight; _saveWeightLocal(today,r.weight); }
      setDayType(dayType); renderFoodList(); updateMacrosBar();
      document.getElementById('claudeBtn').disabled=currentItems.filter(x=>x.type==='food').length===0;
      setSyncStatus('ok');
      return;
    }
  }catch(e){ setSyncStatus('offline'); }
  // fallback: local draft only if it's from today
  try{
    const d=JSON.parse(localStorage.getItem('draft_today'));
    if(d && d.date===today){ dayType=d.dayType||'rest'; currentItems=d.items||[];
      refreshItemMacros();
      setDayType(dayType); renderFoodList(); updateMacrosBar();
      document.getElementById('claudeBtn').disabled=currentItems.filter(x=>x.type==='food').length===0;
      loadWeightForDate(); return; }
  }catch(e){}
  // new day â€” empty
  currentItems=[]; dayType='rest';
  setDayType(dayType); renderFoodList(); updateMacrosBar();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEIGHT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getWeights(){ return _getWeightsLocal(); }
function _getWeightsLocal(){ try{ return JSON.parse(localStorage.getItem('weights')||'{}'); }catch(e){ return {}; } }
function _saveWeightLocal(date,val){ const w=_getWeightsLocal(); if(val&&val>0) w[date]=val; else delete w[date]; localStorage.setItem('weights',JSON.stringify(w)); }
function saveWeight(){
  const date=document.getElementById('dayDate').value;
  const val=parseFloat(document.getElementById('weightInput').value)||null;
  _saveWeightLocal(date,val);
  const msg=document.getElementById('weightSavedMsg');
  msg.classList.add('show'); clearTimeout(msg._t);
  msg._t=setTimeout(()=>msg.classList.remove('show'),1500);
  saveDraft();
}
function loadWeightForDate(){
  const date=document.getElementById('dayDate').value;
  const w=_getWeightsLocal();
  document.getElementById('weightInput').value=w[date]!==undefined?w[date]:'';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATE NAVIGATION & WARNING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getTodayStr(){ return new Date().toISOString().split('T')[0]; }
function isViewingToday(){ return document.getElementById('dayDate').value===getTodayStr(); }

function updateNotTodayBanner(){
  let banner=document.getElementById('notTodayBanner');
  if(!banner){
    banner=document.createElement('div');
    banner.id='notTodayBanner';
    banner.style.cssText='display:none;background:rgba(232,93,74,.18);border:2px solid var(--red);color:var(--red);padding:10px 16px;border-radius:10px;font-size:14px;font-weight:800;text-align:center;margin-bottom:12px;letter-spacing:.3px;';
    const scrollArea=document.querySelector('.scroll-area');
    scrollArea.insertBefore(banner, scrollArea.firstChild);
  }
  if(!isViewingToday()){
    const d=new Date(document.getElementById('dayDate').value+'T12:00:00');
    const label=d.toLocaleDateString('he-IL',{weekday:'long',day:'numeric',month:'long'});
    banner.innerHTML=`âš ï¸ ××ª×” ×¦×•×¤×” ×‘<strong>${label}</strong> â€” ×œ× ×”×™×•×! ×›×œ ×©×™× ×•×™ ×™×©××¨ ×œ×™×•× ×–×”`;
    banner.style.display='block';
  } else {
    banner.style.display='none';
  }
}

function guardNotToday(){
  if(!isViewingToday()){
    const d=new Date(document.getElementById('dayDate').value+'T12:00:00');
    const label=d.toLocaleDateString('he-IL',{weekday:'long',day:'numeric',month:'long'});
    showToast(`âš ï¸ ×©×•××¨ ×œ${label} â€” ×œ× ×”×™×•×`,'warn');
  }
  return true;
}

function showToast(msg, type='info'){
  let t=document.getElementById('toastMsg');
  if(!t){
    t=document.createElement('div');
    t.id='toastMsg';
    t.style.cssText='position:fixed;bottom:24px;left:50%;transform:translateX(-50%);padding:10px 20px;border-radius:10px;font-family:Heebo,sans-serif;font-size:14px;font-weight:600;z-index:9999;transition:opacity .4s;pointer-events:none;';
    document.body.appendChild(t);
  }
  t.textContent=msg;
  t.style.background=type==='warn'?'rgba(232,160,50,.95)':'rgba(62,207,142,.95)';
  t.style.color='#0f1117';
  t.style.opacity='1';
  clearTimeout(t._timer);
  t._timer=setTimeout(()=>t.style.opacity='0',2500);
}

async function onDateChange(){
  // CRITICAL: save current data IMMEDIATELY before switching date
  const dateEl=document.getElementById('dayDate');
  const prevDate=dateEl._prevDate;
  const newDate=dateEl.value;

  if(prevDate && prevDate!==newDate && currentItems.length>0){
    // cancel pending timer and save immediately with snapshot
    clearTimeout(_saveDraftTimer);
    const itemsSnap=JSON.parse(JSON.stringify(currentItems));
    const typeSnap=dayType;
    console.log(`[DATE CHANGE] saving ${prevDate} â†’ ${newDate}, items:${itemsSnap.length}`);
    localStorage.setItem('draft_today',JSON.stringify({date:prevDate,dayType:typeSnap,items:itemsSnap}));
    await _persistDay(prevDate,itemsSnap,typeSnap);
  } else {
    console.log(`[DATE CHANGE] ${prevDate} â†’ ${newDate}, items:${currentItems.length} â€” no save needed`);
  }
  dateEl._prevDate=newDate;
  loadWeightForDate();
  updateNotTodayBanner();
  // load from Supabase
  try{
    const rows=await sbGet('days',`select=*&date=eq.${newDate}&limit=1`);
    if(rows&&rows.length){
      const r=rows[0]; dayType=r.day_type||'rest'; currentItems=r.items||[];
      refreshItemMacros();
      if(r.weight){ document.getElementById('weightInput').value=r.weight; _saveWeightLocal(newDate,r.weight); }
      setDayType(dayType); renderFoodList(); updateMacrosBar();
      document.getElementById('claudeBtn').disabled=currentItems.filter(x=>x.type==='food').length===0;
      setSyncStatus('ok');
    } else {
      // no data for this date â€” show empty
      currentItems=[]; dayType='rest';
      document.getElementById('weightInput').value='';
      setDayType(dayType); renderFoodList(); updateMacrosBar();
      document.getElementById('claudeBtn').disabled=true;
    }
  }catch(e){
    // offline â€” try localStorage history
    try{
      const h=JSON.parse(localStorage.getItem('history')||'[]');
      const entry=h.find(x=>x.date===newDate);
      if(entry){ dayType=entry.dayType||'rest'; currentItems=entry.items||[];
        refreshItemMacros(); setDayType(dayType); renderFoodList(); updateMacrosBar();
      } else { currentItems=[]; renderFoodList(); updateMacrosBar(); }
    }catch(e2){ currentItems=[]; renderFoodList(); updateMacrosBar(); }
    setSyncStatus('offline');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HISTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function getHistory(){
  try{
    const rows=await sbGet('days','select=date,day_type,items,totals,weight&order=date.desc&limit=150');
    if(rows&&rows.length){
      const h=rows.map(r=>({date:r.date,dayType:r.day_type,items:r.items,totals:r.totals}));
      localStorage.setItem('history',JSON.stringify(h));
      const w={}; rows.forEach(r=>{ if(r.weight) w[r.date]=r.weight; });
      localStorage.setItem('weights',JSON.stringify({..._getWeightsLocal(),...w}));
      return h;
    }
  }catch(e){ console.warn('history load',e); }
  return JSON.parse(localStorage.getItem('history')||'[]');
}
async function renderHistory(){
  document.getElementById('historyList').innerHTML='<div class="empty-state">â³ ×˜×•×¢×Ÿ...</div>';
  const h=await getHistory(), weights=_getWeightsLocal();
  const list=document.getElementById('historyList');
  if(!h.length){list.innerHTML='<div class="empty-state">××™×Ÿ ×”×™×¡×˜×•×¨×™×” ×¢×“×™×™×Ÿ</div>';return;}
  list.innerHTML=h.map(x=>{
    const w=weights[x.date];
    const wBadge=w?`<span class="history-weight-badge">âš– ${w} ×§×´×’</span>`:'';;
    const d=new Date(x.date+'T00:00:00');
    const dateStr=d.toLocaleDateString('he-IL',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
    return `<div class="history-item">
      <div class="history-header">
        <span class="history-date" onclick="loadDay('${x.date}')" title="×˜×¢×Ÿ ×™×•×">${dateStr}</span>
        <div style="display:flex;gap:8px;align-items:center;">${wBadge}
          <div class="history-type ${x.dayType}">${x.dayType==='rest'?'×× ×•×—×”':'××™××•×Ÿ'}</div>
        </div>
      </div>
      <div class="history-macros">
        <div class="history-macro">×§×œ×³ <span>${Math.round(x.totals.cal)}</span></div>
        <div class="history-macro">×—×œ×‘×•×Ÿ <span>${Math.round(x.totals.prot)}×’×³</span></div>
        <div class="history-macro">×¤×—××™××•×ª <span>${Math.round(x.totals.carb)}×’×³</span></div>
        <div class="history-macro">×©×•×× ×™× <span>${Math.round(x.totals.fat)}×’×³</span></div>
      </div>
      <div class="history-actions">
        <button class="hist-btn load" onclick="loadDay('${x.date}')">ğŸ“‚ ×˜×¢×Ÿ ×™×•×</button>
        <button class="hist-btn clone" onclick="openClonePopup('${x.date}')">ğŸ“‹ ×©×›×¤×œ ×œ×™×•× ××—×¨</button>
        <button class="hist-btn del" onclick="deleteHistoryDay('${x.date}')">ğŸ—‘</button>
      </div>
    </div>`;
  }).join('');
}
async function loadDay(date){
  try{
    const rows=await sbGet('days',`select=*&date=eq.${date}&limit=1`);
    if(rows&&rows.length){
      const r=rows[0]; document.getElementById('dayDate').value=r.date;
      dayType=r.day_type||'rest'; currentItems=r.items||[];
      refreshItemMacros();
      if(r.weight){ document.getElementById('weightInput').value=r.weight; _saveWeightLocal(date,r.weight); }
      else document.getElementById('weightInput').value='';
      setDayType(dayType); renderFoodList(); updateMacrosBar(); switchTab('today'); setSyncStatus('ok'); return;
    }
  }catch(e){ console.warn('loadDay',e); }
  // local fallback
  const h=JSON.parse(localStorage.getItem('history')||'[]');
  const entry=h.find(x=>x.date===date); if(!entry) return;
  document.getElementById('dayDate').value=entry.date;
  dayType=entry.dayType; currentItems=entry.items;
  refreshItemMacros();
  loadWeightForDate(); setDayType(dayType); renderFoodList(); updateMacrosBar(); switchTab('today');
}

// ×—×™×©×•×‘ ××—×“×© ×©×œ ×›×œ ×”×¤×¨×™×˜×™× ×œ×¤×™ × ×ª×•× ×™ ×˜×‘×œ×ª ×”×™×¡×•×“ ×”× ×•×›×—×™×ª
function refreshItemMacros(){
  currentItems.forEach((item,i)=>{
    if(item.type!=='food'||item.free) return;
    const food=getFoodForItem(item);
    if(!food) return;
    const m=calcMacros(food,item.amount);
    currentItems[i]={...item,id:food.id,...m};
  });
}
async function deleteHistoryDay(date){
  if(!confirm('×œ××—×•×§ ×™×•× ×–×” ××”×”×™×¡×˜×•×¨×™×”?')) return;
  try{ await sbDelete('days',`date=eq.${date}`); }catch(e){ console.warn(e); }
  localStorage.setItem('history',JSON.stringify(JSON.parse(localStorage.getItem('history')||'[]').filter(x=>x.date!==date)));
  renderHistory();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLONE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openClonePopup(fromDate){
  // set source date input
  document.getElementById('cloneSourceDate').value=fromDate;
  updateCloneSourceLabel();
  // default target = tomorrow
  const tomorrow=new Date(); tomorrow.setDate(tomorrow.getDate()+1);
  document.getElementById('cloneTargetDate').value=tomorrow.toISOString().split('T')[0];
  document.getElementById('cloneOverlay').style.display='';
  document.getElementById('clonePopup').style.display='';
}
function updateCloneSourceLabel(){
  const val=document.getElementById('cloneSourceDate').value;
  const el=document.getElementById('cloneSourceName');
  if(!val){el.textContent='';return;}
  const d=new Date(val+'T00:00:00');
  el.textContent=d.toLocaleDateString('he-IL',{weekday:'long',day:'numeric',month:'long'});
  // check if exists in history
  const h=JSON.parse(localStorage.getItem('history')||'[]');
  const exists=h.find(x=>x.date===val);
  el.style.color=exists?'var(--green)':'var(--red)';
  el.textContent+= exists?' âœ“':' (×œ× × ××¦×)';
}
function closeClonePopup(){
  document.getElementById('cloneOverlay').style.display='none';
  document.getElementById('clonePopup').style.display='none';
}
async function confirmClone(){
  const sourceDate=document.getElementById('cloneSourceDate').value;
  const targetDate=document.getElementById('cloneTargetDate').value;
  if(!sourceDate||!targetDate){alert('×™×© ×œ×‘×—×•×¨ ×©× ×™ ×ª××¨×™×›×™×');return;}
  if(targetDate===sourceDate){alert('×ª××¨×™×š ×”×™×¢×“ ×–×”×” ×œ××§×•×¨');return;}
  // try to load source from Supabase first
  let source=null;
  try{
    const rows=await sbGet('days',`select=*&date=eq.${sourceDate}&limit=1`);
    if(rows&&rows.length) source=rows[0];
  }catch(e){}
  // fallback to local
  if(!source){
    const h=JSON.parse(localStorage.getItem('history')||'[]');
    const loc=h.find(x=>x.date===sourceDate);
    if(loc) source={date:loc.date,day_type:loc.dayType,items:loc.items,totals:loc.totals};
  }
  if(!source){alert('×œ× × ××¦× ×™×•× ××§×•×¨ â€” ×•×“× ×©×”×ª××¨×™×š × ×›×•×Ÿ');return;}
  const cloned={...source,date:targetDate,items:JSON.parse(JSON.stringify(source.items||[]))};
  try{
    await sbUpsert('days',{date:targetDate,day_type:cloned.day_type,items:cloned.items,totals:cloned.totals,updated_at:new Date().toISOString()});
    setSyncStatus('ok');
  }catch(e){ setSyncStatus('error'); console.warn(e); }
  closeClonePopup();
  document.getElementById('dayDate').value=targetDate;
  dayType=cloned.day_type||'rest'; currentItems=JSON.parse(JSON.stringify(cloned.items));
  loadWeightForDate();
  setDayType(dayType); renderFoodList(); updateMacrosBar(); switchTab('today');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let statsRangeDays=7;
function initStatsRange(){
  const to=new Date(), from=new Date();
  from.setDate(to.getDate()-(statsRangeDays-1));
  document.getElementById('statsTo').value=to.toISOString().split('T')[0];
  document.getElementById('statsFrom').value=from.toISOString().split('T')[0];
}
function setRange(days,btn){
  statsRangeDays=days;
  document.querySelectorAll('.range-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  initStatsRange();
  renderStats();
}
function applyCustomRange(){
  document.querySelectorAll('.range-btn').forEach(b=>b.classList.remove('active'));
  statsRangeDays=0;
  renderStats();
}
function renderStats(){
  const from=document.getElementById('statsFrom').value;
  const to=document.getElementById('statsTo').value;
  if(!from||!to) return;
  const h=JSON.parse(localStorage.getItem('history')||'[]').filter(x=>x.date>=from&&x.date<=to)
    .sort((a,b)=>a.date.localeCompare(b.date));
  const weights=getWeights();

  // KPIs
  const n=h.length;
  document.getElementById('kpiDays').textContent=n||'â€”';
  if(n===0){
    ['kpiCal','kpiProt','kpiCarb'].forEach(id=>document.getElementById(id).textContent='â€”');
    document.getElementById('kpiWeight').textContent='â€”';
    document.getElementById('kpiWeightSub').textContent='××™×Ÿ × ×ª×•× ×™×';
    document.getElementById('chartSvgWrap').innerHTML='<div class="empty-state">××™×Ÿ × ×ª×•× ×™× ×‘×˜×•×•×— ×”× ×‘×—×¨</div>';
    document.getElementById('statsTableBody').innerHTML='<tr><td colspan="7" style="text-align:center;padding:24px;color:var(--text2)">××™×Ÿ × ×ª×•× ×™×</td></tr>';
    document.getElementById('statsTableFoot').innerHTML='';
    return;
  }
  const avgCal=h.reduce((s,x)=>s+x.totals.cal,0)/n;
  const avgProt=h.reduce((s,x)=>s+x.totals.prot,0)/n;
  const avgCarb=h.reduce((s,x)=>s+x.totals.carb,0)/n;
  document.getElementById('kpiCal').textContent=Math.round(avgCal);
  document.getElementById('kpiProt').textContent=Math.round(avgProt);
  document.getElementById('kpiCarb').textContent=Math.round(avgCarb);

  // weight delta
  const wDates=h.map(x=>x.date).filter(d=>weights[d]!==undefined);
  if(wDates.length>=2){
    const first=weights[wDates[0]], last=weights[wDates[wDates.length-1]];
    const delta=(last-first).toFixed(1);
    const sign=delta>0?'+':'';
    document.getElementById('kpiWeight').textContent=sign+delta;
    document.getElementById('kpiWeight').style.color=delta<0?'var(--green)':delta>0?'var(--red)':'var(--text)';
    document.getElementById('kpiWeightSub').textContent=`${first}â†’${last} ×§×´×’`;
  } else {
    document.getElementById('kpiWeight').textContent=wDates.length===1?weights[wDates[0]]+'':'â€”';
    document.getElementById('kpiWeightSub').textContent='× ×“×¨×©×™× â‰¥2 ××“×™×“×•×ª';
  }

  // Chart (SVG)
  renderChart(h, weights);

  // Table
  const tbody=document.getElementById('statsTableBody');
  const totalCal=h.reduce((s,x)=>s+x.totals.cal,0);
  const totalProt=h.reduce((s,x)=>s+x.totals.prot,0);
  const totalCarb=h.reduce((s,x)=>s+x.totals.carb,0);
  const totalFat=h.reduce((s,x)=>s+x.totals.fat,0);
  tbody.innerHTML=h.map(x=>{
    const d=new Date(x.date+'T00:00:00');
    const dStr=d.toLocaleDateString('he-IL',{weekday:'short',day:'numeric',month:'numeric'});
    const w=weights[x.date];
    return `<tr>
      <td onclick="loadDay('${x.date}')" title="×˜×¢×Ÿ ×™×•×">${dStr}</td>
      <td><span class="${x.dayType==='rest'?'badge-rest':'badge-train'}">${x.dayType==='rest'?'×× ×•×—×”':'××™××•×Ÿ'}</span></td>
      <td class="td-cal">${Math.round(x.totals.cal)}</td>
      <td class="td-prot">${Math.round(x.totals.prot)}</td>
      <td class="td-carb">${Math.round(x.totals.carb)}</td>
      <td class="td-fat">${Math.round(x.totals.fat)}</td>
      <td class="td-wt">${w!==undefined?w:'â€”'}</td>
    </tr>`;
  }).join('');
  document.getElementById('statsTableFoot').innerHTML=`<tr>
    <td colspan="2">×××•×¦×¢ ×™×•××™ (${n} ×™××™×)</td>
    <td class="td-cal">${Math.round(avgCal)}</td>
    <td class="td-prot">${Math.round(avgProt)}</td>
    <td class="td-carb">${Math.round(avgCarb)}</td>
    <td class="td-fat">${Math.round(totalFat/n)}</td>
    <td class="td-wt">â€”</td>
  </tr>`;
}

function renderChart(days, weights){
  const wrap=document.getElementById('chartSvgWrap');
  if(!days.length){ wrap.innerHTML=''; return; }
  const W=Math.max(600, days.length*52), H=200, PAD={t:16,r:20,b:36,l:52};
  const cw=W-PAD.l-PAD.r, ch=H-PAD.t-PAD.b;

  const cals=days.map(d=>d.totals.cal);
  const maxCal=Math.max(...cals,2200), minCal=Math.min(...cals,1400);
  const calRange=maxCal-minCal||1;
  const scY=v=>ch-((v-minCal)/calRange)*ch+PAD.t;
  const scX=i=>PAD.l+i*(cw/(days.length-1||1));

  // weight scale (right axis)
  const wVals=days.map(d=>weights[d.date]).filter(v=>v!==undefined);
  const maxW=wVals.length?Math.max(...wVals)+1:100;
  const minW=wVals.length?Math.min(...wVals)-1:80;
  const wRange=maxW-minW||1;
  const scWY=v=>ch-((v-minW)/wRange)*ch+PAD.t;

  // cal bars
  const barW=Math.min(30, cw/days.length*0.6);
  const bars=days.map((d,i)=>{
    const x=scX(i)-barW/2, bH=((d.totals.cal-minCal)/calRange)*ch, y=PAD.t+ch-bH;
    const col=d.dayType==='train'?'rgba(79,156,249,.55)':'rgba(245,166,35,.55)';
    return `<rect x="${x}" y="${y}" width="${barW}" height="${bH}" fill="${col}" rx="3"/>`;
  }).join('');

  // cal line
  const calPts=days.map((d,i)=>`${scX(i)},${scY(d.totals.cal)}`).join(' ');

  // weight line
  let weightLine='', weightDots='';
  const wPairs=days.map((d,i)=>({i,v:weights[d.date]})).filter(p=>p.v!==undefined);
  if(wPairs.length>=2){
    const wPts=wPairs.map(p=>`${scX(p.i)},${scWY(p.v)}`).join(' ');
    weightLine=`<polyline points="${wPts}" fill="none" stroke="var(--accent2)" stroke-width="2.5" stroke-dasharray="4 2"/>`;
    weightDots=wPairs.map(p=>`<circle cx="${scX(p.i)}" cy="${scWY(p.v)}" r="4" fill="var(--accent2)"/><title>${p.v} ×§"×’</title>`).join('');
  }

  // X labels (every N days)
  const step=Math.ceil(days.length/8);
  const xLabels=days.map((d,i)=>{
    if(i%step!==0&&i!==days.length-1) return '';
    const dd=new Date(d.date+'T00:00:00');
    const lbl=dd.toLocaleDateString('he-IL',{day:'numeric',month:'numeric'});
    return `<text x="${scX(i)}" y="${H-4}" text-anchor="middle" font-size="10" fill="var(--text2)" font-family="Heebo,sans-serif">${lbl}</text>`;
  }).join('');

  // Y axis labels
  const yTicks=[minCal, (minCal+maxCal)/2, maxCal].map(v=>
    `<text x="${PAD.l-6}" y="${scY(v)+4}" text-anchor="end" font-size="10" fill="var(--text2)" font-family="Rajdhani,sans-serif">${Math.round(v)}</text>`
  ).join('');

  // Legend
  const legend=`
    <rect x="${W-120}" y="${PAD.t}" width="12" height="10" fill="rgba(245,166,35,.55)" rx="2"/>
    <text x="${W-104}" y="${PAD.t+9}" font-size="10" fill="var(--text2)" font-family="Heebo,sans-serif">×× ×•×—×”</text>
    <rect x="${W-60}" y="${PAD.t}" width="12" height="10" fill="rgba(79,156,249,.55)" rx="2"/>
    <text x="${W-44}" y="${PAD.t+9}" font-size="10" fill="var(--text2)" font-family="Heebo,sans-serif">××™××•×Ÿ</text>
    ${wPairs.length>=2?`<line x1="${W-120}" y1="${PAD.t+22}" x2="${W-108}" y2="${PAD.t+22}" stroke="var(--accent2)" stroke-width="2.5" stroke-dasharray="4 2"/>
    <text x="${W-104}" y="${PAD.t+26}" font-size="10" fill="var(--text2)" font-family="Heebo,sans-serif">××©×§×œ</text>`:''}`;

  wrap.innerHTML=`<svg viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg" style="width:100%;min-width:${W}px;height:${H}px;display:block;">
    <line x1="${PAD.l}" y1="${PAD.t}" x2="${PAD.l}" y2="${PAD.t+ch}" stroke="var(--border)" stroke-width="1"/>
    <line x1="${PAD.l}" y1="${PAD.t+ch}" x2="${W-PAD.r}" y2="${PAD.t+ch}" stroke="var(--border)" stroke-width="1"/>
    ${bars}
    <polyline points="${calPts}" fill="none" stroke="var(--orange)" stroke-width="2" opacity=".6"/>
    ${weightLine}${weightDots}
    ${yTicks}${xLabels}${legend}
  </svg>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLAUDE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function analyzeWithClaude(){
  const btn=document.getElementById('claudeBtn'),box=document.getElementById('analysisBox');
  btn.disabled=true; btn.textContent='â³ ×× ×ª×—...';
  box.style.display=''; box.className='analysis-box'; box.textContent='×××ª×™×Ÿ ×œ× ×™×ª×•×—...';
  const t=totals(),tgt=TARGETS[dayType];
  const foodItems=currentItems.filter(x=>x.type==='food');
  const itemsText=foodItems.map(x=>`â€¢ ${x.name}: ${x.amount} ${x.unit} â†’ ${x.cal} ×§×œ×³, ${x.prot}×’' ×—×œ×‘×•×Ÿ, ${x.carb}×’' ×¤×—××™××•×ª, ${x.fat}×’' ×©×•××Ÿ`).join('\n');
  const prompt=`××ª×” ×™×•×¢×¥ ×ª×–×•× ×”. ×¨××™, 55, ×’×‘×¨, ×××•×§×“ ×™×¨×™×“×” ×‘××©×§×œ ×-85 ×œ-80-82 ×§"×’ ×¢× ×©××™×¨×” ×¢×œ ××¡×ª ×©×¨×™×¨. ××™××•× ×™ ×›×•×— ×¤×¢××™×™× ×‘×©×‘×•×¢.
×¡×•×’ ×™×•×: ${dayType==='rest'?'×™×•× ×× ×•×—×” (×™×¢×“: 1,650 ×§×œ×³)':'×™×•× ××™××•×Ÿ (×™×¢×“: 1,975 ×§×œ×³)'}
××” ××›×œ ×¢×“ ×›×”:\n${itemsText}
×¡×”"×›: ${Math.round(t.cal)} ×§×œ×³ | ×—×œ×‘×•×Ÿ: ${Math.round(t.prot)}×’' | ×¤×—××™××•×ª: ${Math.round(t.carb)}×’' | ×©×•×× ×™×: ${Math.round(t.fat)}×’'
×™×¢×“×™×: ${tgt.cal} ×§×œ×³ | ×—×œ×‘×•×Ÿ ${tgt.protMin}-${tgt.protMax}×’' | ×¤×—××™××•×ª ${tgt.carbMin}-${tgt.carbMax}×’' | ×©×•×× ×™× ${tgt.fatMin}-${tgt.fatMax}×’'
× ×ª×— ×§×¦×¨ ×•××•×¢×™×œ ×‘×¢×‘×¨×™×ª ×¢× ×¡××œ×™× âœ…âš ï¸âŒ: 1) ×¡×˜×˜×•×¡ × ×•×›×—×™ 2) ××” ×—×¡×¨/×¢×•×“×£ 3) ×”××œ×¦×” ×§×•× ×§×¨×˜×™×ª ×œ×”×©×œ××ª ×”×™×•×`;
  try{
    const resp=await fetch('https://klyndyhhelhnebknrvax.supabase.co/functions/v1/claude-proxy',{method:'POST',headers:{'Content-Type':'application/json','apikey':SUPA_KEY,'Authorization':'Bearer '+SUPA_KEY},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:1000,messages:[{role:'user',content:prompt}]})});
    const data=await resp.json();
    if(!resp.ok){ box.textContent='âš ï¸ ×©×’×™××” '+resp.status+': '+JSON.stringify(data); btn.disabled=false; btn.innerHTML='<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l3 3"/></svg> ×‘×§×© × ×™×ª×•×— ××§×œ×•×“'; return; }
    box.textContent=data.content?.map(c=>c.text||'').join('')||'×œ× ×”×ª×§×‘×œ×” ×ª×©×•×‘×”';
    saveToHistory();
  }catch(err){
    box.textContent='âš ï¸ ×©×’×™××ª ×¨×©×ª: '+err.message;
  }
  btn.disabled=false;
  btn.innerHTML='<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l3 3"/></svg> ×‘×§×© × ×™×ª×•×— ××§×œ×•×“';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FREE ITEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let freeItemEditingIndex=null;

function openFreeItemPopup(itemIndex){
  freeItemEditingIndex=itemIndex;
  const isEdit=itemIndex!==null;
  document.querySelector('.free-item-popup h3').textContent=isEdit?'âœ ×¢×¨×•×š ×¤×¨×™×˜ ×—×•×¤×©×™':'âœ ×¤×¨×™×˜ ×˜×§×¡×˜ ×—×•×¤×©×™';
  if(isEdit){
    const item=currentItems[itemIndex];
    document.getElementById('fipName').value=item.name;
    document.getElementById('fipCal').value=item.cal;
    document.getElementById('fipProt').value=item.prot;
    document.getElementById('fipCarb').value=item.carb;
    document.getElementById('fipFat').value=item.fat;
  } else {
    document.getElementById('fipName').value='';
    document.getElementById('fipCal').value='';
    document.getElementById('fipProt').value='';
    document.getElementById('fipCarb').value='';
    document.getElementById('fipFat').value='';
  }
  document.getElementById('fipDesc').value='';
  document.getElementById('freeItemOverlay').style.display='';
  document.getElementById('freeItemPopup').style.display='';
  // close food selector
  document.getElementById('foodSelector').style.display='none';
  setTimeout(()=>document.getElementById('fipName').focus(),60);
}

function closeFreeItemPopup(){
  document.getElementById('freeItemOverlay').style.display='none';
  document.getElementById('freeItemPopup').style.display='none';
  freeItemEditingIndex=null;
}

function confirmFreeItem(){
  const name=document.getElementById('fipName').value.trim();
  if(!name){ alert('× × ×œ×”×–×™×Ÿ ×©× ×œ×¤×¨×™×˜'); document.getElementById('fipName').focus(); return; }
  const cal=parseFloat(document.getElementById('fipCal').value)||0;
  const prot=parseFloat(document.getElementById('fipProt').value)||0;
  const carb=parseFloat(document.getElementById('fipCarb').value)||0;
  const fat=parseFloat(document.getElementById('fipFat').value)||0;
  const item={type:'food',free:true,id:null,name,amount:1,unit:'×× ×”',cal,prot,carb,fat};
  if(freeItemEditingIndex!==null){
    currentItems[freeItemEditingIndex]={...currentItems[freeItemEditingIndex],...item};
  } else {
    currentItems.push(item);
  }
  closeFreeItemPopup();
  renderFoodList(); updateMacrosBar(); saveDraft();
  document.getElementById('claudeBtn').disabled=currentItems.filter(x=>x.type==='food').length===0;
}

async function estimateWithClaude(){
  const desc=document.getElementById('fipDesc').value.trim();
  if(!desc){ alert('× × ×œ×ª××¨ ××ª ×”××–×•×Ÿ ×œ×¤× ×™ ×”×”×¢×¨×›×”'); return; }
  const btn=document.getElementById('fipEstimateBtn');
  btn.disabled=true; btn.innerHTML='â³ ××¢×¨×™×š...';
  const prompt=`××ª×” ×ª×–×•× ××™. ×”×¢×¨×š ××ª ×”×¢×¨×›×™× ×”×ª×–×•× ×ª×™×™× ×©×œ: "${desc}".
×¢× ×” ONLY ×‘×¤×•×¨××˜ JSON ×‘×œ×‘×“ (×œ×œ× ×˜×§×¡×˜ × ×•×¡×£), ×›×š:
{"name":"×©× ×”××–×•×Ÿ ×‘×¢×‘×¨×™×ª","cal":123,"prot":12.5,"carb":15,"fat":5.5}
cal=×§×œ×•×¨×™×•×ª, prot=×—×œ×‘×•×Ÿ ×’×¨×, carb=×¤×—××™××•×ª ×’×¨×, fat=×©×•××Ÿ ×’×¨×. ×¢×¨×›×™× ××“×•×™×§×™× ×›×›×œ ×”××¤×©×¨.`;
  try{
    const resp=await fetch('https://klyndyhhelhnebknrvax.supabase.co/functions/v1/claude-proxy',{
      method:'POST',headers:{'Content-Type':'application/json','apikey':SUPA_KEY,'Authorization':'Bearer '+SUPA_KEY},
      body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:200,messages:[{role:'user',content:prompt}]})
    });
    const data=await resp.json();
    const txt=data.content?.map(c=>c.text||'').join('')||'';
    const match=txt.match(/\{[^}]+\}/);
    if(!match) throw new Error('no json');
    const result=JSON.parse(match[0]);
    if(result.name) document.getElementById('fipName').value=result.name;
    if(result.cal!==undefined) document.getElementById('fipCal').value=Math.round(result.cal);
    if(result.prot!==undefined) document.getElementById('fipProt').value=Math.round(result.prot*10)/10;
    if(result.carb!==undefined) document.getElementById('fipCarb').value=Math.round(result.carb*10)/10;
    if(result.fat!==undefined) document.getElementById('fipFat').value=Math.round(result.fat*10)/10;
  }catch(err){
    alert('âš ï¸ ×œ× × ×™×ª×Ÿ ×œ×”×¢×¨×™×š â€” ×•×“× ×—×™×‘×•×¨ API ×ª×§×£');
  }
  btn.disabled=false;
  btn.innerHTML='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l3 3"/></svg> ×”×¢×¨×š ×¢×¨×›×™× ×ª×–×•× ×ª×™×™×';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NOTES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let notesSaveTimer=null;
let _notesRowId=null;
function saveNotes(){
  const txt=document.getElementById('notesTextarea').value;
  localStorage.setItem('userNotes',txt);
  document.getElementById('notesCharCount').textContent=txt.length.toLocaleString()+' ×ª×•×•×™×';
  const msg=document.getElementById('notesSavedMsg');
  msg.style.opacity='1';
  clearTimeout(notesSaveTimer);
  notesSaveTimer=setTimeout(async()=>{
    msg.style.opacity='0';
    try{
      if(!_notesRowId){ const rows=await sbGet('notes','select=id&limit=1'); if(rows&&rows.length) _notesRowId=rows[0].id; }
      if(_notesRowId) await sbUpsert('notes',{id:_notesRowId,content:txt,updated_at:new Date().toISOString()});
      else await sbUpsert('notes',{content:txt,updated_at:new Date().toISOString()});
    }catch(e){ console.warn('notes save',e); }
  },1500);
}
async function loadNotes(){
  const local=localStorage.getItem('userNotes')||'';
  document.getElementById('notesTextarea').value=local;
  document.getElementById('notesCharCount').textContent=local.length?local.length.toLocaleString()+' ×ª×•×•×™×':'';
  try{
    const rows=await sbGet('notes','select=id,content&order=updated_at.desc&limit=1');
    if(rows&&rows.length){ _notesRowId=rows[0].id;
      const txt=rows[0].content||'';
      document.getElementById('notesTextarea').value=txt;
      document.getElementById('notesCharCount').textContent=txt.length?txt.length.toLocaleString()+' ×ª×•×•×™×':'';
      localStorage.setItem('userNotes',txt);
    }
  }catch(e){ console.warn('notes load',e); }
}

// keyboard
document.addEventListener('keydown',e=>{
  if(e.key==='Enter'&&document.getElementById('amountPopup').style.display!=='none') confirmAddFood();
  if(e.key==='Escape'){
    closeAmountPopup();
    document.getElementById('foodSelector').style.display='none';
    closeSettings();
    closeClonePopup();
    closeFreeItemPopup();
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI â€” TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(tab){
  ['today','history','stats','notes'].forEach(t=>{
    document.getElementById('tab-'+t).style.display = t===tab ? (t==='today'?'flex':'block') : 'none';
  });
  document.querySelectorAll('.tab').forEach(b=>{
    b.classList.toggle('active', b.dataset.tab===tab);
  });
  if(tab==='history') renderHistory();
  if(tab==='stats') renderStats();
  if(tab==='notes') loadNotes();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI â€” DAY TYPE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setDayType(type){
  dayType=type;
  document.getElementById('btn-rest').className='day-type-btn'+(type==='rest'?' active-rest':'');
  document.getElementById('btn-train').className='day-type-btn'+(type==='train'?' active-train':'');
  const tgt=TARGETS[type];
  document.getElementById('targetCal').textContent='×™×¢×“: '+tgt.cal.toLocaleString();
  updateMacrosBar();
  saveDraft();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI â€” FOOD GRID
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderFoodGrid(){
  const grid=document.getElementById('foodGrid'); if(!grid) return;
  grid.innerHTML='';
  const q=(document.getElementById('foodSearch')||{value:''}).value.toLowerCase();
  FOODS.filter(f=>!q||f.name.toLowerCase().includes(q)).forEach(f=>{
    const btn=document.createElement('button');
    btn.className='food-card';
    const cal = f.perUnit ? f.perUnit.cal : Math.round(f.per100.cal * (f.defaultAmount||100) / 100);
    btn.innerHTML=`<div class="food-card-name">${f.name}</div><div class="food-card-cal">${cal} ×§×œ×³</div>`;
    btn.onclick=()=>addFoodImmediate(f.id);
    grid.appendChild(btn);
  });
}

function filterFoods(){
  renderFoodGrid();
}

function toggleFoodSelector(){
  const sel=document.getElementById('foodSelector');
  const isOpen = sel.style.display!=='none';
  sel.style.display = isOpen ? 'none' : 'block';
  if(!isOpen){
    guardNotToday(); // show warning toast if not today, but don't block
    renderFoodGrid();
    const search=document.getElementById('foodSearch');
    if(search){ search.value=''; search.focus(); }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI â€” FOOD LIST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderFoodList(){
  const list=document.getElementById('foodItemsList');
  if(!list) return;
  if(!currentItems.length){
    list.innerHTML='<div class="empty-state">×˜×¨× ×”×•×¡×¤×ª ××–×•× ×•×ª ×œ×”×™×•×</div>';
    const tr=document.getElementById('totalsRow');
    if(tr) tr.style.display='none';
    document.getElementById('claudeBtn').disabled=true;
    return;
  }
  document.getElementById('claudeBtn').disabled=false;
  list.innerHTML='';
  currentItems.forEach((item,idx)=>{
    if(item.section){
      const div=document.createElement('div');
      div.className='section-header';
      div.draggable=true;
      div.ondragstart=e=>listDragStart(e,idx);
      div.ondragover=e=>listDragOver(e,idx);
      div.ondrop=e=>listDrop(e,idx);
      div.innerHTML=`
        <span class="drag-handle">â ¿</span>
        <input type="text" class="section-input" value="${item.label||''}"
          onchange="updateSectionText(${idx},this.value)" placeholder="×©× ××¨×•×—×”...">
        <button class="delete-btn" onclick="removeItem(${idx})">âœ•</button>`;
      list.appendChild(div);
      return;
    }
    const food=getFoodForItem(item);
    const macros=calcMacros(item);
    const div=document.createElement('div');
    div.className='food-item';
    div.draggable=true;
    div.ondragstart=e=>listDragStart(e,idx);
    div.ondragover=e=>listDragOver(e,idx);
    div.ondrop=e=>listDrop(e,idx);
    const unitLabel = item.free ? '×× ×”' : (food ? food.unit||'×’×¨×' : '×’×¨×');
    const nameDisplay = item.free ? (item.name||'×¤×¨×™×˜ ×—×•×¤×©×™') : (food ? food.name : item.name||'?');
    div.innerHTML=`
      <span class="drag-handle">â ¿</span>
      <span class="food-name" title="${nameDisplay}">${nameDisplay}</span>
      <div class="food-amount-ctrl">
        <button class="spin-btn" onclick="spinAmount(${idx},-1)">âˆ’</button>
        <input class="food-amount-input" type="number" min="0" step="1"
          value="${item.amount}" onchange="updateItemAmount(${idx},+this.value)">
        <span class="food-unit-label">${unitLabel}</span>
        <button class="spin-btn" onclick="spinAmount(${idx},+1)">+</button>
      </div>
      <span class="food-cal">${macros.cal}</span>
      <span class="food-prot">${macros.prot}</span>
      <span class="food-carb">${macros.carb}</span>
      <span class="food-fat">${macros.fat}</span>
      <button class="delete-btn" onclick="removeItem(${idx})">âœ•</button>`;
    list.appendChild(div);
  });
  updateTotalsRow();
}

function calcMacros(item){
  if(item.free) return {cal:item.cal||0,prot:item.prot||0,carb:item.carb||0,fat:item.fat||0};
  const food=getFoodForItem(item);
  if(!food) return {cal:0,prot:0,carb:0,fat:0};
  const amt=item.amount||0;
  if(food.perUnit){
    return {
      cal:Math.round(food.perUnit.cal*amt),
      prot:Math.round(food.perUnit.prot*amt*10)/10,
      carb:Math.round(food.perUnit.carb*amt*10)/10,
      fat:Math.round(food.perUnit.fat*amt*10)/10
    };
  }
  const p=food.per100;
  return {
    cal:Math.round(p.cal*amt/100),
    prot:Math.round(p.prot*amt/100*10)/10,
    carb:Math.round(p.carb*amt/100*10)/10,
    fat:Math.round(p.fat*amt/100*10)/10
  };
}

function totals(){
  return currentItems.reduce((acc,item)=>{
    const m=calcMacros(item);
    acc.cal+=m.cal; acc.prot+=m.prot; acc.carb+=m.carb; acc.fat+=m.fat;
    return acc;
  },{cal:0,prot:0,carb:0,fat:0});
}

function updateTotalsRow(){
  const t=totals();
  const tr=document.getElementById('totalsRow');
  if(!tr) return;
  tr.style.display=currentItems.filter(i=>!i.section).length ? 'grid' : 'none';
  document.getElementById('sumCal').textContent=t.cal;
  document.getElementById('sumProt').textContent=Math.round(t.prot*10)/10;
  document.getElementById('sumCarb').textContent=Math.round(t.carb*10)/10;
  document.getElementById('sumFat').textContent=Math.round(t.fat*10)/10;
}

function updateItemAmount(idx,val){
  if(isNaN(val)||val<0) return;
  currentItems[idx].amount=val;
  renderFoodList(); updateMacrosBar(); saveDraft();
}

function spinAmount(idx,delta){
  const item=currentItems[idx];
  const food=getFoodForItem(item);
  const step = food&&food.perUnit ? 1 : 5;
  item.amount=Math.max(0,(item.amount||0)+delta*step);
  renderFoodList(); updateMacrosBar(); saveDraft();
}

function removeItem(idx){
  currentItems.splice(idx,1);
  renderFoodList(); updateMacrosBar(); saveDraft();
}

function updateSectionText(idx,val){
  currentItems[idx].label=val; saveDraft();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI â€” MACROS BAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateMacrosBar(){
  const t=totals();
  const tgt=TARGETS[dayType]||TARGETS.rest;
  
  document.getElementById('totalCal').textContent=t.cal;
  document.getElementById('totalProt').textContent=Math.round(t.prot*10)/10;
  document.getElementById('totalCarb').textContent=Math.round(t.carb*10)/10;
  document.getElementById('totalFat').textContent=Math.round(t.fat*10)/10;

  // Progress bars
  const setProg=(id,val,max)=>{
    const el=document.getElementById(id); if(!el) return;
    el.style.width=Math.min(100,Math.round(val/max*100))+'%';
  };
  setProg('progCal',t.cal,tgt.cal);
  setProg('progProt',t.prot,tgt.protMax);
  setProg('progCarb',t.carb,tgt.carbMax);
  setProg('progFat',t.fat,tgt.fatMax);

  function statusForCal(v,target){
    const pct=v/target;
    if(pct<0.7) return 'low';
    if(pct<=1.05) return 'ok';
    if(pct<=1.15) return 'warn';
    return 'over';
  }
  function statusForRange(v,min,max){
    if(v<min*0.8) return 'low';
    if(v<=max) return 'ok';
    if(v<=max*1.15) return 'warn';
    return 'over';
  }
  function applyStatus(valueId,statusId,gapId,status){
    const vel=document.getElementById(valueId);
    const sel=document.getElementById(statusId);
    const gel=document.getElementById(gapId);
    if(!vel||!sel) return;
    const cls={'low':'status-low','ok':'status-ok','warn':'status-warn','over':'status-over'};
    const valCls={'low':'val-low','ok':'val-ok','warn':'val-warn','over':'val-over'};
    sel.className='macro-status '+cls[status];
    vel.className='macro-value '+valCls[status];
    const icons={'low':'â†‘','ok':'âœ…','warn':'âš ','over':'âŒ'};
    sel.textContent=icons[status]||'â€”';
  }
  applyStatus('totalCal','statusCal','gapCal', statusForCal(t.cal, tgt.cal));
  applyStatus('totalProt','statusProt','gapProt', statusForRange(t.prot, tgt.protMin, tgt.protMax));
  applyStatus('totalCarb','statusCarb','gapCarb', statusForRange(t.carb, tgt.carbMin, tgt.carbMax));
  applyStatus('totalFat','statusFat','gapFat',  statusForRange(t.fat,  tgt.fatMin,  tgt.fatMax));

  // Gap labels
  function gapText(id,val,min,max){
    const el=document.getElementById(id); if(!el) return;
    if(val>=min && val<=max){ el.textContent='âœ… ×‘×™×¢×“'; el.className='macro-gap gap-positive'; }
    else if(val<min){ el.textContent='â†‘ ×—×¡×¨×™× '+Math.round(min-val)+'×’'; el.className='macro-gap gap-warn'; }
    else{ const over=Math.round(val-max); el.textContent=(over>20?'âŒ':'âš ')+' ×¢×•×“×£ '+over+'×’'; el.className='macro-gap '+(over>20?'gap-over':'gap-warn'); }
  }
  function gapTextCal(id,val,target){
    const el=document.getElementById(id); if(!el) return;
    const diff=target-val;
    if(Math.abs(diff)<=target*0.05){ el.textContent='âœ… ×‘×™×¢×“'; el.className='macro-gap gap-positive'; }
    else if(diff>0){ el.textContent='â†‘ ×—×¡×¨×•×ª '+diff+'×§×œ'; el.className='macro-gap gap-warn'; }
    else{ el.textContent=(Math.abs(diff)>target*0.15?'âŒ':'âš ')+' ×¢×•×“×£ '+Math.abs(diff)+'×§×œ'; el.className='macro-gap '+(Math.abs(diff)>target*0.15?'gap-over':'gap-warn'); }
  }
  gapTextCal('gapCal',t.cal,tgt.cal);
  gapText('gapProt',t.prot,tgt.protMin,tgt.protMax);
  gapText('gapCarb',t.carb,tgt.carbMin,tgt.carbMax);
  gapText('gapFat',t.fat,tgt.fatMin,tgt.fatMax);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADD FOOD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addFoodImmediate(foodId){
  const food=getFoodById(foodId); if(!food) return;
  currentItems.push({id:food.id, name:food.name, amount:food.defaultAmount||100});
  // keep selector open so user can add multiple items
  renderFoodList(); updateMacrosBar(); saveDraft();
  // brief flash on the card to confirm addition
  const grid=document.getElementById('foodGrid');
  if(grid){
    const cards=[...grid.querySelectorAll('.food-card')];
    const card=cards.find(c=>c.onclick&&c.onclick.toString().includes(foodId));
  }
}

function addSectionHeader(){
  guardNotToday(); // warning only
  currentItems.push({section:true, label:'××¨×•×—×”'});
  renderFoodList(); saveDraft();
  // Focus the last section input
  setTimeout(()=>{
    const inputs=document.querySelectorAll('.section-input');
    if(inputs.length) inputs[inputs.length-1].focus();
  },50);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AMOUNT POPUP (click food name to edit)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function closeAmountPopup(){
  const ov=document.getElementById('overlay'); if(ov) ov.style.display='none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openSettings(){
  document.getElementById('settingsOverlay').classList.add('open');
  renderDbTable();
}
function closeSettings(){
  document.getElementById('settingsOverlay').classList.remove('open');
}
function closeSettingsOutside(e){
  if(e.target===document.getElementById('settingsOverlay')) closeSettings();
}

function renderDbTable(){
  const tbody=document.getElementById('dbTableRows'); if(!tbody) return;
  tbody.innerHTML='';
  FOODS.forEach(food=>{
    const isUnit=!!food.perUnit;
    const macros=isUnit ? food.perUnit : food.per100;
    const row=document.createElement('div');
    row.className='db-table-row';
    row.draggable=true;
    row.ondragstart=e=>dbDragStart(e,food.id);
    row.ondragover=e=>dbDragOver(e,food.id);
    row.ondrop=e=>dbDrop(e,food.id);
    row.innerHTML=`
      <span class="drag-handle">â ¿</span>
      <span class="db-food-name" ondblclick="toggleEditName(${food.id})" id="name-display-${food.id}">${food.name}</span>
      <input type="text" class="db-edit-name" id="name-edit-${food.id}" value="${food.name}"
        style="display:none" onblur="saveFoodName(${food.id})" onkeydown="if(event.key==='Enter')saveFoodName(${food.id})">
      <select class="db-unit-select" onchange="updateFoodUnit(${food.id},this.value)">
        <option value="per100" ${!isUnit?'selected':''}>×œ×›×œ 100×’</option>
        <option value="perUnit" ${isUnit?'selected':''}>×œ×™×—×™×“×”</option>
      </select>
      <input type="number" class="db-macro-input" value="${macros.cal}" 
        onchange="updateFoodMacro(${food.id},'cal',+this.value)" title="×§×œ×•×¨×™×•×ª">
      <input type="number" class="db-macro-input" value="${macros.prot}" 
        onchange="updateFoodMacro(${food.id},'prot',+this.value)" title="×—×œ×‘×•×Ÿ">
      <input type="number" class="db-macro-input" value="${macros.carb}" 
        onchange="updateFoodMacro(${food.id},'carb',+this.value)" title="×¤×—××™××•×ª">
      <input type="number" class="db-macro-input" value="${macros.fat}" 
        onchange="updateFoodMacro(${food.id},'fat',+this.value)" title="×©×•××Ÿ">
      <input type="number" class="db-macro-input" value="${food.defaultAmount||100}" 
        onchange="updateFoodField(${food.id},'defaultAmount',+this.value)" title="×›××•×ª ×‘×¨×™×¨×ª ××—×“×œ">
      <button class="delete-btn" onclick="deleteFoodFromDB(${food.id})">âœ•</button>`;
    tbody.appendChild(row);
  });
}

function updateFoodUnit(id, newUnit){
  const food=getFoodById(id); if(!food) return;
  if(newUnit==='perUnit' && food.per100){
    food.perUnit={...food.per100}; delete food.per100;
  } else if(newUnit==='per100' && food.perUnit){
    food.per100={...food.perUnit}; delete food.perUnit;
  }
  saveFoodsDB(); renderDbTable(); renderFoodGrid();
}
function updateFoodField(id,field,val){
  const food=getFoodById(id); if(!food) return;
  food[field]=val; saveFoodsDB();
}
function updateFoodMacro(id,macro,val){
  const food=getFoodById(id); if(!food) return;
  const macros=food.perUnit||food.per100;
  macros[macro]=val; saveFoodsDB();
}
function toggleEditName(id){
  document.getElementById('name-display-'+id).style.display='none';
  const inp=document.getElementById('name-edit-'+id);
  inp.style.display='inline-block'; inp.focus(); inp.select();
}
function saveFoodName(id){
  const inp=document.getElementById('name-edit-'+id); if(!inp) return;
  const food=getFoodById(id); if(!food) return;
  food.name=inp.value.trim()||food.name;
  saveFoodsDB();
  document.getElementById('name-display-'+id).textContent=food.name;
  document.getElementById('name-display-'+id).style.display='inline';
  inp.style.display='none';
  renderFoodGrid();
}
function deleteFoodFromDB(id){
  if(!confirm('×œ××—×•×§ ××–×•×Ÿ ×–×” ××”×××’×¨?')) return;
  FOODS=FOODS.filter(f=>f.id!==id); saveFoodsDB(); renderDbTable(); renderFoodGrid();
}
function addNewFood(){
  const name=document.getElementById('newFoodName').value.trim();
  if(!name){alert('×”×›× ×¡ ×©× ××–×•×Ÿ');return;}
  const food={id:Date.now(), name, per100:{cal:0,prot:0,carb:0,fat:0}, defaultAmount:100, unit:'×’×¨×'};
  FOODS.push(food); saveFoodsDB();
  document.getElementById('newFoodName').value='';
  renderDbTable(); renderFoodGrid();
}

// Drag for food list
function listDragStart(e,idx){listDragSrc=idx;}
function listDragOver(e,idx){e.preventDefault();e.currentTarget.classList.add('drag-over');}
function listDrop(e,targetIdx){
  e.currentTarget.classList.remove('drag-over');
  if(listDragSrc===null||listDragSrc===targetIdx) return;
  const item=currentItems.splice(listDragSrc,1)[0];
  currentItems.splice(targetIdx,0,item);
  listDragSrc=null;
  renderFoodList(); saveDraft();
}

// Drag for DB
function dbDragStart(e,id){dbDragSrc=id;}
function dbDragOver(e,id){e.preventDefault();e.currentTarget.classList.add('db-drag-over');}
function dbDrop(e,targetId){
  e.currentTarget.classList.remove('db-drag-over');
  if(!dbDragSrc||dbDragSrc===targetId) return;
  const srcIdx=FOODS.findIndex(f=>f.id===dbDragSrc);
  const tgtIdx=FOODS.findIndex(f=>f.id===targetId);
  if(srcIdx<0||tgtIdx<0) return;
  const item=FOODS.splice(srcIdx,1)[0];
  FOODS.splice(tgtIdx,0,item);
  dbDragSrc=null;
  saveFoodsDB(); renderDbTable();
}
function dbDragEnd(){
  document.querySelectorAll('.db-table-row').forEach(r=>r.classList.remove('db-drag-over'));
  dbDragSrc=null;
}

// Confirm add food (from popup if exists)
function confirmAddFood(){
  const sel=document.getElementById('foodSelector');
  if(sel) sel.style.display='none';
}

// Update preview in free item popup
function updatePreview(){
  const cal=+document.getElementById('fipCal').value||0;
  const prot=+document.getElementById('fipProt').value||0;
  const carb=+document.getElementById('fipCarb').value||0;
  const fat=+document.getElementById('fipFat').value||0;
  const els=['Cal','Prot','Carb','Fat'];
  const vals=[cal,prot,carb,fat];
  els.forEach((e,i)=>{
    const el=document.getElementById('prev'+e); if(el) el.textContent=vals[i];
  });
}

// getFoodForItem helper (in case not defined)
function getFoodForItem(item){
  if(!item||item.free) return null;
  return FOODS.find(f=>f.id===item.id) || FOODS.find(f=>f.name===item.name) || null;
}

</script>
</body>
</html>
